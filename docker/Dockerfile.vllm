# syntax=docker/dockerfile:1
# =============================================================================
# vLLM Backend: High-performance inference with PagedAttention
# =============================================================================
# vLLM backend with continuous batching and tensor parallelism support
#
# Usage:
#   docker build -f docker/Dockerfile.vllm \
#     --build-arg BASE_IMAGE=llm-energy-measure-base:latest \
#     -t llm-energy-measure:vllm .
#
# Note: vLLM installs its own PyTorch version (2.8+), which differs from
# the pytorch backend (2.5.x). This is intentional for compatibility.
# =============================================================================

ARG BASE_IMAGE=llm-energy-measure-base:latest

# ============================================================================
# Stage 1: Builder - Install vLLM and dependencies
# ============================================================================
FROM ${BASE_IMAGE} AS builder

WORKDIR /build

# Install vLLM (brings its own compatible PyTorch)
# Pin version for reproducibility - update as needed
RUN pip install --no-cache-dir vllm>=0.6.0

# Copy project files
COPY pyproject.toml poetry.lock* README.md ./
COPY src/ ./src/

# Install the package WITHOUT torch dependency (vLLM provides it)
# Then install remaining deps explicitly
RUN pip install --no-cache-dir --no-deps . \
    && pip install --no-cache-dir \
        transformers \
        datasets \
        pydantic \
        loguru \
        typer \
        pynvml \
        codecarbon \
        calflops \
        schedule \
        accelerate

# ============================================================================
# Stage 2: Runtime - Minimal production image
# ============================================================================
FROM ${BASE_IMAGE} AS runtime

# Copy virtual environment from builder
COPY --from=builder /opt/venv /opt/venv

# Clear NVIDIA's entrypoint and set default command
ENTRYPOINT []
CMD ["llm-energy-measure", "--help"]

# ============================================================================
# Stage 3: Dev - For development with source mounting
# ============================================================================
FROM ${BASE_IMAGE} AS dev

# Install vLLM (brings its own PyTorch)
RUN pip install --no-cache-dir vllm>=0.6.0

# Install remaining dependencies for dev
RUN pip install --no-cache-dir \
    transformers \
    datasets \
    pydantic \
    loguru \
    typer \
    pynvml \
    codecarbon \
    calflops \
    schedule \
    accelerate \
    poetry-core build pytest pytest-cov ruff mypy

# Source will be mounted at runtime for editable install
ENTRYPOINT []
CMD ["/bin/bash"]
