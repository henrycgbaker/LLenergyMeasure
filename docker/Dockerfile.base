# syntax=docker/dockerfile:1
# =============================================================================
# Base Image: CUDA + Python foundation for all backends
# =============================================================================
# Shared system dependencies - backends install their own PyTorch version
#
# Usage:
#   docker build -f docker/Dockerfile.base -t llm-energy-measure-base:latest .
# =============================================================================

FROM nvidia/cuda:12.4.1-runtime-ubuntu22.04 AS base

# System dependencies shared by all backends
# gosu: for dropping privileges in entrypoint (PUID/PGID support)
# Python 3.10: Required for tensorrt-llm compatibility (only supports 3.10/3.12)
RUN apt-get update && apt-get install -y --no-install-recommends \
    software-properties-common \
    && add-apt-repository -y ppa:deadsnakes/ppa \
    && apt-get update && apt-get install -y --no-install-recommends \
    python3.10 \
    python3.10-venv \
    python3.10-dev \
    python3-pip \
    libgomp1 \
    git \
    curl \
    gosu \
    && rm -rf /var/lib/apt/lists/* \
    && ln -sf /usr/bin/python3.10 /usr/bin/python3 \
    && ln -sf /usr/bin/python3.10 /usr/bin/python

# Create venv structure (backends will install into this)
RUN python -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"
ENV VIRTUAL_ENV="/opt/venv"
ENV PYTHONUNBUFFERED=1

# Upgrade pip once
RUN pip install --no-cache-dir --upgrade pip

# Common working directory
WORKDIR /app

# Create writable directories for non-root users
# - results: experiment outputs
# - .state: experiment state/resumption
# - .cache/huggingface: model cache
RUN mkdir -p /app/results /app/.state /app/.cache/huggingface \
    && chmod 777 /app/results /app/.state /app/.cache/huggingface

# HuggingFace cache location
ENV HF_HOME=/app/.cache/huggingface

# Copy entrypoint script
COPY scripts/entrypoint.sh /usr/local/bin/entrypoint.sh
RUN chmod +x /usr/local/bin/entrypoint.sh
