[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"

[project]
name = "llenergymeasure"
version = "1.17.0"
description = "LLenergyMeasure - LLM inference efficiency measurement framework"
authors = [
    {name = "henrycgbaker", email = "henry.c.g.baker@gmail.com"},
]
readme = "README.md"
requires-python = ">=3.10"
dependencies = [
    "pydantic>=2.0",
    "typer>=0.9",
    "pyyaml>=6.0",
    "platformdirs>=3.0",
    "nvidia-ml-py>=12.0",
    "numpy>=1.24",
    "pyarrow>=14.0",
    "tqdm>=4.66",
    "loguru>=0.7",
]

[project.optional-dependencies]
pytorch = [
    "torch>=2.5",
    "transformers>=4.49",
    "accelerate>=1.4",
    "bitsandbytes>=0.45",
    "calflops>=0.2",
    "peft>=0.18",
]
vllm = ["vllm>=0.6"]
tensorrt = ["tensorrt-llm>=0.12"]
zeus = ["zeus>=0.13.1"]
codecarbon = ["codecarbon>=2.8"]
webhooks = ["httpx>=0.23"]
dev = [
    "pytest>=8.0",
    "pytest-cov>=4.0",
    "ruff>=0.8",
    "mypy>=1.0",
    "types-pyyaml>=6.0.12",
]

[project.scripts]
llem = "llenergymeasure.cli:app"

[tool.hatch.build.targets.wheel]
packages = ["src/llenergymeasure"]

[tool.ruff]
line-length = 100
target-version = "py310"

[tool.ruff.lint]
select = ["E", "F", "I", "UP", "B", "SIM", "RUF"]
ignore = ["E501"]  # Line length handled by formatter

[tool.ruff.format]
quote-style = "double"
indent-style = "space"

[tool.mypy]
python_version = "3.10"
strict = true
ignore_missing_imports = true
# Disable checks that fail on untyped third-party libs (torch, transformers)
disallow_untyped_calls = false
# Allow unused type: ignore comments (needed for cross-environment compatibility)
warn_unused_ignores = false
exclude = [
    "experiment_core_utils",
    "experiment_orchestration_utils",
    "configs",
    # v1.x legacy modules â€” will be replaced/deleted by subsequent PRs
    "core/warmup\\.py",
    "core/model_loader\\.py",
    "core/flops\\.py",
    "core/dataset_loader\\.py",
    "core/gpu_info\\.py",
    "core/state\\.py",
    "core/inference_backends/",
    "config/validation\\.py",
    "cli/config\\.py",
    "cli/display",
    "cli/experiment\\.py",
    "cli/results\\.py",
    "cli/config_cmd\\.py",
    "cli/_vram\\.py",
    "orchestration/",
    "results/exporters\\.py",
    "results/aggregation\\.py",
    "core/timeseries\\.py",
    "core/backends/pytorch\\.py",
]

[tool.pytest.ini_options]
testpaths = ["tests"]
python_files = ["test_*.py"]
python_functions = ["test_*"]
addopts = "-v --tb=short -m \"not gpu\""
markers = [
    "gpu: marks tests as requiring GPU hardware (deselect with '-m \"not gpu\"')",
]
