---
phase: 02.2
plan: 03
subsystem: container-strategy
tags: [docker, containers, campaign, orchestration]
depends_on:
  requires: ["02.2-02"]
  provides: ["dual-container-strategy", "ContainerManager"]
  affects: ["campaign-execution", "docker-lifecycle"]
tech_stack:
  added: []
  patterns: ["strategy-pattern", "context-manager"]
key_files:
  created:
    - src/llenergymeasure/orchestration/container.py
  modified:
    - src/llenergymeasure/cli/campaign.py
decisions:
  - key: "container-strategy-flag"
    choice: "--container-strategy CLI flag with ephemeral|persistent options"
    rationale: "Explicit override for user control; CLI > config > default precedence"
  - key: "persistent-mode-warning"
    choice: "Show warning and require confirmation for persistent mode (unless --yes)"
    rationale: "Users should understand tradeoffs (less isolation, GPU memory accumulation)"
  - key: "auto-teardown-configurable"
    choice: "user_config.docker.auto_teardown controls container lifecycle"
    rationale: "Some users may want to keep containers running for manual inspection"
metrics:
  tasks: 2
  duration: 6min
  completed: 2025-02-03
---

# Phase 2.2 Plan 03: Dual Container Strategy Summary

**One-liner:** ContainerManager for persistent containers; campaign CLI supports ephemeral (default) and persistent (opt-in) strategies via CLI flag or config.

## What Was Built

### Task 1: ContainerManager (orchestration/container.py)
New module implementing persistent container lifecycle management:

- **ContainerState** dataclass: Tracks service status (stopped/starting/running/error) and restart count
- **ContainerManager** dataclass with methods:
  - `start_all()`: `docker compose up -d` for all services
  - `exec(service, command, env)`: `docker compose exec` with env var passthrough
  - `stop_all()`: `docker compose down`
  - `restart_service(service)`: Individual service restart
- Context manager support (`__enter__`/`__exit__`) for automatic teardown
- Warmup delay option after container start
- Auto-recovery: If exec called on stopped container, attempts start_all()

### Task 2: Dual Strategy in Campaign CLI (cli/campaign.py)
Campaign CLI now supports both container strategies:

1. **CLI flag**: `--container-strategy [ephemeral|persistent]`
2. **Strategy precedence**: CLI > user config (.lem-config.yaml) > default (ephemeral)
3. **Ephemeral mode** (default):
   - Uses `docker compose run --rm` per experiment
   - Better isolation, each experiment gets fresh container
   - Unchanged from previous behaviour
4. **Persistent mode** (opt-in):
   - Uses `docker compose up -d` + `docker compose exec`
   - Containers stay warm between experiments
   - Warning shown requiring confirmation (unless --yes)
   - Faster iteration during development
5. **Auto-teardown**: Configurable via `user_config.docker.auto_teardown`

## Key Code Changes

```python
# Strategy determination (CLI > config > default)
effective_strategy: Literal["ephemeral", "persistent"]
if container_strategy is not None:
    effective_strategy = container_strategy
else:
    effective_strategy = user_config.docker.strategy

# Persistent mode setup
if effective_strategy == "persistent":
    container_manager = ContainerManager(
        services=backends_needed,
        warmup_delay=user_config.docker.warmup_delay,
        auto_teardown=user_config.docker.auto_teardown,
    )
    container_manager.start_all()

# Experiment execution with persistent containers
if container_manager is not None:
    result = container_manager.exec(backend, cmd, env=env_vars)
else:
    # Ephemeral mode: docker compose run --rm
    subprocess.run(cmd, ...)
```

## Commits

| Hash | Type | Description |
|------|------|-------------|
| 948a790 | feat | Add ContainerManager for persistent container lifecycle |
| 70606d6 | feat | Implement dual container strategy in campaign CLI |

## Deviations from Plan

None - plan executed exactly as written.

## Verification Results

1. ContainerManager import: OK
2. ContainerManager methods (start_all, exec, stop_all): True True True
3. CLI flag visible in help: `--container-strategy` present
4. Strategy logic: `effective_strategy` used at 5 locations
5. All imports work correctly

## Usage Examples

```bash
# Default ephemeral mode (unchanged)
lem campaign campaign.yaml

# Persistent mode via CLI flag
lem campaign campaign.yaml --container-strategy persistent

# Persistent mode via config (.lem-config.yaml)
# docker:
#   strategy: persistent
#   warmup_delay: 2.0
#   auto_teardown: true
lem campaign campaign.yaml
```

## Files Changed

| File | Change |
|------|--------|
| `src/llenergymeasure/orchestration/container.py` | Created (204 lines) |
| `src/llenergymeasure/cli/campaign.py` | Modified (+104/-18 lines) |

## Next Phase Readiness

Plan 02.2-03 complete. Remaining in Phase 2.2:
- Plan 04: Backend auto-detection (if any)

All success criteria met:
- ContainerManager class with start_all(), exec(), stop_all() methods
- Campaign CLI has --container-strategy [ephemeral|persistent] flag
- Ephemeral mode is default and unchanged
- Persistent mode works via config or CLI override
- Persistent mode shows warning and confirms with user (unless --yes)
- Auto-teardown configurable via user config
