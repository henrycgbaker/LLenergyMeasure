---
phase: 02.2-campaign-execution-model
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/llenergymeasure/cli/campaign.py
  - src/llenergymeasure/config/user_config.py
autonomous: true

must_haves:
  truths:
    - "TensorRT experiments route to 'tensorrt' container (not 'base' or other incorrect service)"
    - "User can configure thermal gaps in .lem-config.yaml and campaign uses those defaults"
    - "Config loading from .lem-config.yaml is graceful (missing file = use defaults)"
  artifacts:
    - path: "src/llenergymeasure/config/user_config.py"
      provides: "User preferences loading from .lem-config.yaml"
      contains: "class UserConfig"
    - path: "src/llenergymeasure/cli/campaign.py"
      provides: "Container routing fix and thermal gap config loading"
      contains: "load_user_config"
  key_links:
    - from: "src/llenergymeasure/cli/campaign.py"
      to: "_build_docker_command"
      via: "backend parameter"
      pattern: "backend.*tensorrt"
    - from: "src/llenergymeasure/cli/campaign.py"
      to: "src/llenergymeasure/config/user_config.py"
      via: "load_user_config function"
      pattern: "from.*user_config.*import.*load_user_config"
---

<objective>
Fix TensorRT container routing bug and implement minimal user config loading for thermal gap defaults.

Purpose: TensorRT experiments incorrectly route to 'base' container instead of 'tensorrt'. Additionally, users want configurable thermal gap defaults via `.lem-config.yaml` without needing the full setup wizard (Phase 2.3). This plan fixes the routing and adds minimal config loading.

Output: Container routing correctly maps backends to Docker Compose service names; minimal user config loading from `.lem-config.yaml` for thermal gap defaults.
</objective>

<execution_context>
@/home/h.baker@hertie-school.lan/.claude/get-shit-done/workflows/execute-plan.md
@/home/h.baker@hertie-school.lan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02.2-CONTEXT.md

@src/llenergymeasure/cli/campaign.py
@docker-compose.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create user config loading module</name>
  <files>src/llenergymeasure/config/user_config.py</files>
  <action>
Create a new module `user_config.py` for loading user preferences from `.lem-config.yaml`:

```python
"""User preferences configuration loading.

Loads optional user preferences from .lem-config.yaml in project root.
This is a minimal implementation for Phase 2.2 (thermal gaps, docker strategy).
Full user preferences system (lem init wizard) is Phase 2.3.
"""

from __future__ import annotations

from pathlib import Path
from typing import Any, Literal

import yaml
from pydantic import BaseModel, Field


class ThermalGapConfig(BaseModel):
    """Thermal gap configuration."""

    between_experiments: float = Field(
        default=60.0,
        ge=0,
        description="Seconds between experiments within a cycle",
    )
    between_cycles: float = Field(
        default=300.0,
        ge=0,
        description="Seconds between cycles",
    )


class DockerConfig(BaseModel):
    """Docker execution configuration."""

    strategy: Literal["ephemeral", "persistent"] = Field(
        default="ephemeral",
        description="Container strategy: ephemeral (run --rm) or persistent (up + exec)",
    )
    warmup_delay: float = Field(
        default=0.0,
        ge=0,
        description="Seconds to wait after container start before first experiment",
    )
    auto_teardown: bool = Field(
        default=True,
        description="Auto-teardown containers after campaign (persistent mode only)",
    )


class UserConfig(BaseModel):
    """User preferences loaded from .lem-config.yaml.

    All fields are optional with sensible defaults. Missing file
    or fields gracefully fall back to defaults.
    """

    thermal_gaps: ThermalGapConfig = Field(
        default_factory=ThermalGapConfig,
        description="Thermal gap settings",
    )
    docker: DockerConfig = Field(
        default_factory=DockerConfig,
        description="Docker execution settings",
    )
    default_backend: str = Field(
        default="pytorch",
        description="Default backend for single-backend campaigns",
    )
    results_dir: str = Field(
        default="results",
        description="Default results directory",
    )


def load_user_config(config_path: Path | None = None) -> UserConfig:
    """Load user configuration from .lem-config.yaml.

    Args:
        config_path: Optional explicit path. Defaults to .lem-config.yaml in cwd.

    Returns:
        UserConfig with values from file or defaults if file missing.
    """
    if config_path is None:
        config_path = Path(".lem-config.yaml")

    if not config_path.exists():
        # No config file - return defaults
        return UserConfig()

    try:
        with open(config_path) as f:
            data = yaml.safe_load(f) or {}
        return UserConfig.model_validate(data)
    except Exception:
        # Invalid config - return defaults (don't crash)
        return UserConfig()


__all__ = [
    "DockerConfig",
    "ThermalGapConfig",
    "UserConfig",
    "load_user_config",
]
```
  </action>
  <verify>
```bash
python -c "from llenergymeasure.config.user_config import load_user_config, UserConfig; c = load_user_config(); print(f'thermal gaps: {c.thermal_gaps.between_experiments}s, {c.thermal_gaps.between_cycles}s'); print(f'docker strategy: {c.docker.strategy}')"
# Should print defaults: 60s, 300s, ephemeral
```
  </verify>
  <done>User config module created with ThermalGapConfig, DockerConfig, UserConfig models and load_user_config() function that gracefully handles missing files.</done>
</task>

<task type="auto">
  <name>Task 2: Fix container routing and apply user config defaults in campaign.py</name>
  <files>src/llenergymeasure/cli/campaign.py</files>
  <action>
Update campaign.py to fix container routing and use user config defaults:

1. **Fix container routing** - The `_build_docker_command()` function and service selection must correctly map backends to Docker Compose service names. Verify/fix:
   - `pytorch` -> `pytorch` service
   - `vllm` -> `vllm` service
   - `tensorrt` -> `tensorrt` service

   Check that the backend variable is used directly as the service name (it should be). If there's any mapping or defaulting to 'base', remove it.

2. **Load user config and apply thermal gap defaults** - At the start of `campaign_cmd()`:
   ```python
   from llenergymeasure.config.user_config import load_user_config

   # Load user preferences (gracefully handles missing file)
   user_config = load_user_config()
   ```

3. **Use user config for thermal gap defaults** - When building `CampaignExecutionConfig` from CLI args (multiple config files mode), use user config as defaults:
   ```python
   execution = CampaignExecutionConfig(
       cycles=cycles or 3,
       structure=structure_typed or "interleaved",
       warmup_prompts=warmup_prompts if warmup_prompts is not None else 5,
       warmup_timeout_seconds=warmup_timeout if warmup_timeout is not None else 30.0,
       # Use user config defaults for thermal gaps
       config_gap_seconds=(
           config_gap if config_gap is not None
           else user_config.thermal_gaps.between_experiments
       ),
       cycle_gap_seconds=(
           cycle_gap if cycle_gap is not None
           else user_config.thermal_gaps.between_cycles
       ),
   )
   ```

4. **Store user_config for later use** (container strategy, needed by Plan 03):
   Store `user_config` so it's available for container strategy decision. For now, just ensure it's loaded and thermal gaps are applied.

5. **Debug logging** - Add debug log when using user config:
   ```python
   from loguru import logger

   if user_config.thermal_gaps.between_experiments != 60.0 or user_config.thermal_gaps.between_cycles != 300.0:
       logger.debug(
           "Using user config thermal gaps: {}s between experiments, {}s between cycles",
           user_config.thermal_gaps.between_experiments,
           user_config.thermal_gaps.between_cycles,
       )
   ```
  </action>
  <verify>
```bash
# Verify user config import
grep -n "from llenergymeasure.config.user_config import" src/llenergymeasure/cli/campaign.py

# Verify container routing uses backend directly
grep -n "docker.*compose.*run" src/llenergymeasure/cli/campaign.py
# Should show backend variable used directly as service name

# Verify thermal gap defaults use user_config
grep -n "user_config.thermal_gaps" src/llenergymeasure/cli/campaign.py
```
  </verify>
  <done>Campaign CLI loads user config from .lem-config.yaml, uses thermal gap defaults from user config, and container routing correctly maps backend names to service names.</done>
</task>

</tasks>

<verification>
1. Run linting: `ruff check src/llenergymeasure/config/user_config.py src/llenergymeasure/cli/campaign.py`
2. Run formatting: `ruff format src/llenergymeasure/config/user_config.py src/llenergymeasure/cli/campaign.py`
3. Test user config loading: `python -c "from llenergymeasure.config.user_config import load_user_config; print(load_user_config())"`
4. Verify module imports: `python -c "from llenergymeasure.config import user_config; print('OK')"`
</verification>

<success_criteria>
- New `user_config.py` module with UserConfig, ThermalGapConfig, DockerConfig models
- `load_user_config()` function that gracefully returns defaults for missing file
- Campaign CLI loads user config and uses thermal gap defaults
- Backend-to-service mapping is direct (no 'base' fallback)
- All code passes ruff check and format
</success_criteria>

<output>
After completion, create `.planning/phases/02.2-campaign-execution-model/02.2-02-SUMMARY.md`
</output>
