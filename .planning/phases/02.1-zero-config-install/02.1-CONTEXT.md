# Phase 2.1: Zero-Config Install Experience — Context

**Created:** 2026-01-30
**Phase goal:** Users install via `pip install llenergymeasure` and everything works out of the box. Docker auto-detected and configured when needed. No manual `setup.sh` required.

## Decisions

### 1. Execution Model: Local-First, Docker for Multi-Backend

- **Local is the default.** `pip install -e ".[pytorch]"` gives a working tool immediately.
- **Docker is opt-in** for multi-backend campaigns or isolation preference.
- Single-backend experiments always run locally if the backend is installed.
- Campaign mode dispatches to Docker containers only when the campaign spans multiple backends.

**Rationale:** Target users are researchers, many on university clusters with conda but no Docker. 90% of usage is single-backend PyTorch. Docker is justified for multi-backend orchestration but shouldn't be a barrier to entry.

### 2. Default Backend: PyTorch in Base Install

- `pip install llenergymeasure` installs core + PyTorch backend dependencies.
- PyTorch is the default because it's the most compatible (any NVIDIA GPU) and most common use case.
- Other backends remain pip extras: `pip install llenergymeasure[vllm]`, `pip install llenergymeasure[tensorrt]`.

### 3. Backend Selection: Runtime Detection + Actionable Errors

- `lem backend list` — shows which backends are importable in the current environment.
- If a user requests a backend that isn't installed, CLI gives actionable error:
  ```
  Error: vLLM backend not installed.
  Install with: pip install llenergymeasure[vllm]
  ```
- No magic subprocess pip installs. Standard Python packaging only.
- No `lem backend install` command — keep it standard (`pip install` extras).

### 4. Two Install Paths

**Path 1 — Local user (most common):**
```bash
pip install -e ".[pytorch]"
lem experiment config.yaml
```

**Path 2 — Local + Docker (multi-backend campaigns):**
```bash
pip install -e ".[pytorch]"
docker compose build pytorch vllm    # Standard Docker Compose commands
lem campaign multi-backend.yaml
```

### 5. Docker Setup: Standard Compose Commands (REVISED)

**Decision (2026-01-31):** After ecosystem research, we decided **not** to implement `lem docker setup/build/status` commands. Industry standard (vLLM, TensorRT-LLM, BentoML, MLflow) is to use standard `docker compose` commands directly. Wrapping these adds complexity without value.

Users set up Docker via:
```bash
docker compose build pytorch vllm tensorrt   # Build needed images
lem doctor                                    # Verify setup
```

`lem doctor` shows Docker readiness (Docker ✓/✗, GPU ✓/✗, images built). This replaces the need for `lem docker status`.

### 6. `.env` Scope and Behaviour

- **Contents:** PUID and PGID only (Docker user-mapping plumbing).
- **No HF_TOKEN in `.env`.** Use `huggingface-cli login` (stores at `~/.cache/huggingface/token`). Docker passes through via `HF_TOKEN=${HF_TOKEN:-}` in docker-compose.yml.
- **Location:** Project root (Docker Compose auto-reads it).
- **Generation:** Auto-generated silently on first Docker use. Log line: "Generated .env with PUID/PGID for Docker".
- **Gitignored:** Must be in `.gitignore`.

### 7. `setup.sh` Removed

- `setup.sh` is deleted entirely.
- Its responsibilities are absorbed by:
  - `pip install` (local setup)
  - `docker compose build` (Docker image building)
  - `make docker-setup` (bootstrap for Docker-only users)
- `make setup` remains as dev setup (`pip install -e ".[pytorch,dev]"` + pre-commit hooks).
- `make docker-setup` added for Docker-only bootstrap path.

### 8. Documentation Refresh Required

- README must be rewritten to reflect the new two-path install story.
- Quickstart guide updated with local-first flow and Docker setup via `docker compose`.
- Backends guide updated with `lem doctor` for diagnostics.
- Deployment guide updated to reference `docker compose build` instead of `setup.sh`.

## Claude's Discretion

- **`_should_use_docker()` refactor:** How to restructure the detection logic. Current implementation is broken — redesign freely.
- **`./lem` wrapper script:** Whether to keep, modify, or remove alongside `setup.sh`. It currently handles Docker dispatch from shell — may be redundant if `lem` CLI handles Docker dispatch natively.
- **Makefile target naming:** `docker-setup` vs `setup-docker` vs similar — pick what fits existing conventions.
- **Error message wording:** Exact phrasing of actionable errors for missing backends, missing Docker, etc.

## Deferred Ideas

- **`lem docker setup/build/status` CLI commands** — After ecosystem research (vLLM, TensorRT-LLM, BentoML, MLflow), industry standard is to use standard `docker compose` commands directly. No ML tool wraps these. `lem doctor` covers the "status" functionality. Users run `docker compose build` directly.
- **`lem backend list` standalone command** — Functionality absorbed by `lem doctor` which shows backend availability alongside other diagnostics.
- **`lem backend install <name>` CLI command** — subprocess pip install from within Python. Fragile in conda/venv. Standard `pip install` extras is sufficient. Could revisit if user feedback demands it.
- **System-wide config at `~/.config/llenergymeasure/`** — over-engineering for now. Project-root `.env` is sufficient.
- **Auto-build Docker images on first campaign run** — too magical. Users should explicitly trigger builds.
