---
phase: 02.1-zero-config-install
plan: 03
type: execute
wave: 3
depends_on: ["02.1-01", "02.1-02"]
files_modified:
  - pyproject.toml
  - Makefile
  - setup.sh
autonomous: true

must_haves:
  truths:
    - "pip install llenergymeasure installs PyTorch backend dependencies by default (torch, transformers, accelerate)"
    - "pip install llenergymeasure[vllm] adds vLLM on top of core+PyTorch"
    - "setup.sh is deleted — no longer exists in repo"
    - "Makefile setup target runs pip install + pre-commit, not ./setup.sh"
    - "Makefile has docker-setup target that runs pip install + lem docker setup"
    - "make dev still works for development setup"
    - "Package is PyPI-publishable: poetry build produces valid sdist and wheel"
  artifacts:
    - path: "pyproject.toml"
      provides: "PyTorch dependencies moved from optional [pytorch] extra to core dependencies"
      contains: "accelerate"
    - path: "Makefile"
      provides: "Updated targets: setup → pip install, docker-setup → pip + lem docker setup"
      contains: "docker-setup"
  key_links:
    - from: "Makefile"
      to: "lem docker setup"
      via: "docker-setup target invokes lem docker setup"
      pattern: "lem docker setup"
---

<objective>
Update packaging so `pip install llenergymeasure` includes PyTorch as default, clean up Makefile targets, delete setup.sh, and validate PyPI-readiness.

Purpose: Users get a working tool from `pip install` alone — no extras needed for the 90% use case (PyTorch). `setup.sh` responsibilities absorbed by `pip install` + `lem docker setup` + `make docker-setup`. Package verified as publishable.

Output: Updated pyproject.toml, updated Makefile, deleted setup.sh, validated wheel install.
</objective>

<execution_context>
@/home/h.baker@hertie-school.lan/.claude/get-shit-done/workflows/execute-plan.md
@/home/h.baker@hertie-school.lan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02.1-zero-config-install/02.1-CONTEXT.md
@pyproject.toml
@Makefile
</context>

<tasks>

<task type="auto">
  <name>Task 1: Move PyTorch deps to core in pyproject.toml</name>
  <files>pyproject.toml</files>
  <action>
Update `pyproject.toml` to make PyTorch backend the default install:

1. **Move these from optional to core `[tool.poetry.dependencies]`:**
   - `accelerate = "^1.4.0"` (remove `optional = true`)
   - `bitsandbytes = "^0.45.0"` (remove `optional = true`)
   - `calflops = "^0.2.0"` (remove `optional = true`)
   - `peft = "^0.18.1"` (remove `optional = true`)

   Note: `torch` and `transformers` are ALREADY in core dependencies. Only the four above need to move.

2. **Update the `[tool.poetry.extras]` section:**
   - Remove the `pytorch` extra entirely (now in core)
   - Keep `vllm`, `tensorrt`, `api`, `dev` extras unchanged
   - Update the `all` extra to remove pytorch deps (they're core now), keep only dev:
     ```toml
     all = ["pytest", "pytest-cov", "ruff", "mypy", "pre-commit", "types-pyyaml", "commitizen"]
     ```
   - Update comments to reflect that base install includes PyTorch

3. **Keep ONNX Runtime as optional** — it's a pytorch-specific optimisation, not needed for basic pytorch operation. Add a new `onnxrt` extra:
   ```toml
   onnxrt = ["onnxruntime-gpu"]
   ```

4. **Update comments** at top of extras section:
   ```toml
   # Base install includes PyTorch backend (torch + transformers + accelerate + bitsandbytes + calflops + peft)
   # Usage: pip install llenergymeasure
   ```
  </action>
  <verify>
`python -c "import toml; d=toml.load('pyproject.toml'); deps=d['tool']['poetry']['dependencies']; print('accelerate' in deps and 'optional' not in str(deps.get('accelerate','')))"` — returns True.
`poetry check` passes (or `pip install -e .` succeeds).
  </verify>
  <done>
`pip install llenergymeasure` (or `pip install -e .`) installs core + PyTorch backend. No `[pytorch]` extra needed for default usage. Optional extras remain for vllm, tensorrt, onnxrt, dev.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Makefile + delete setup.sh</name>
  <files>Makefile, setup.sh</files>
  <action>
**Part A: Update Makefile:**

1. **Replace `setup` target** (currently `@./setup.sh`):
   ```makefile
   setup:
   	pip install -e ".[dev]"
   	pre-commit install
   	@echo "Dev environment ready. Run: lem --help"
   ```

2. **Add `docker-setup` target** (new, for Docker-first users):
   ```makefile
   docker-setup: setup
   	lem docker setup
   	@echo "Docker environment ready. Run: lem campaign <config.yaml>"
   ```

3. **Update `dev` target** to match the new setup (already uses poetry, keep it):
   ```makefile
   dev:
   	poetry install
   	poetry run pre-commit install
   ```
   This remains unchanged — it's the Poetry-specific dev setup.

4. **Update Quick Start comment block** (lines ~12-14):
   ```makefile
   # =============================================================================
   # Quick Start
   #   Local:  make setup       (pip install + pre-commit)
   #   Docker: make docker-setup (above + Docker images)
   #   Dev:    make dev          (poetry install + pre-commit)
   # =============================================================================
   ```

5. **Add `docker-setup` to .PHONY** declaration at top.

6. **Remove references to `./setup.sh`** in any comments.

**Part B: Delete setup.sh:**

Delete `setup.sh` entirely. Its responsibilities are now handled by:
- `pip install -e .` (local setup)
- `lem docker setup` (Docker configuration)
- `make docker-setup` (bootstrap for Docker-first users)
  </action>
  <verify>
`ls setup.sh 2>/dev/null; echo $?` — returns 1 (file does not exist).
`make setup --dry-run` — shows pip install command, not ./setup.sh.
`grep -c 'setup.sh' Makefile` — returns 0.
  </verify>
  <done>
setup.sh deleted. Makefile `setup` target runs pip install, `docker-setup` target runs pip install + lem docker setup. No references to setup.sh remain in Makefile.
  </done>
</task>

<task type="auto">
  <name>Task 3: Validate PyPI packaging readiness</name>
  <files>pyproject.toml</files>
  <action>
Validate that the updated pyproject.toml produces a publishable package:

1. **Build the package:**
   ```bash
   poetry build
   ```
   This should produce both `dist/llenergymeasure-*.tar.gz` (sdist) and `dist/llenergymeasure-*.whl` (wheel) without errors.

2. **Verify package metadata:**
   ```bash
   python -m zipfile -l dist/llenergymeasure-*.whl | head -20
   ```
   Confirm the wheel contains the `llenergymeasure/` package directory.

3. **Test install from wheel in isolated environment:**
   ```bash
   python -m venv /tmp/lem-test-install
   /tmp/lem-test-install/bin/pip install dist/llenergymeasure-*.whl
   /tmp/lem-test-install/bin/python -c "import llenergymeasure; print('Import OK')"
   /tmp/lem-test-install/bin/python -c "from llenergymeasure.config.docker_detection import is_inside_docker; print('Detection module OK')"
   rm -rf /tmp/lem-test-install
   ```

4. **Verify pyproject.toml metadata completeness:**
   Check that these fields exist and are non-empty in pyproject.toml:
   - `name`, `version`, `description`
   - `authors`, `license`
   - `readme` (points to README.md)
   - `packages` (includes the llenergymeasure package)

   If any are missing, add them. The package name should be `llenergymeasure`, description should be concise (one line), license should be present.

5. **Clean up build artifacts:**
   ```bash
   rm -rf dist/
   ```

Do NOT publish to PyPI — only validate that the package is buildable and installable from wheel.
  </action>
  <verify>
```bash
poetry build 2>&1 | tail -3  # Should show "Built llenergymeasure-..." without errors
python -m venv /tmp/lem-pypi-check && /tmp/lem-pypi-check/bin/pip install --no-deps dist/llenergymeasure-*.whl && /tmp/lem-pypi-check/bin/python -c "import llenergymeasure; print('OK')" && rm -rf /tmp/lem-pypi-check dist/
```
  </verify>
  <done>
`poetry build` produces valid sdist and wheel. Wheel installs cleanly in isolated venv. Package metadata (name, version, description, license, readme) is complete. Package is ready for PyPI publishing.
  </done>
</task>

</tasks>

<verification>
```bash
# setup.sh gone
! test -f setup.sh

# Makefile updated
grep 'docker-setup' Makefile
grep -v 'setup.sh' Makefile | wc -l  # No setup.sh references

# pyproject.toml valid
poetry check 2>/dev/null || pip install -e . --dry-run

# Package builds cleanly
poetry build && rm -rf dist/
```
</verification>

<success_criteria>
- pyproject.toml: accelerate, bitsandbytes, calflops, peft in core dependencies (not optional)
- pyproject.toml: [pytorch] extra removed, [onnxrt] extra added
- setup.sh deleted from repo
- Makefile: setup → pip install, docker-setup → pip + lem docker setup
- No references to setup.sh in Makefile
- poetry build produces valid sdist and wheel without errors
- Wheel installs cleanly in isolated venv with all detection modules importable
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-zero-config-install/02.1-03-SUMMARY.md`
</output>
