---
phase: 08.2-m1-tech-debt-cleanup
plan: "02"
subsystem: cli, results, infra
tags: [cleanup, broken-imports, dead-code, public-surface]
dependency_graph:
  requires: []
  provides: [clean-cli-imports, clean-results-surface, clean-infra-surface]
  affects: [cli/experiment.py, cli/utils.py, cli/results.py, cli/display/results.py, results/__init__.py, infra/__init__.py]
tech_stack:
  added: []
  patterns: [inline-field-access]
key_files:
  created: []
  modified:
    - src/llenergymeasure/cli/experiment.py
    - src/llenergymeasure/cli/utils.py
    - src/llenergymeasure/cli/results.py
    - src/llenergymeasure/cli/display/results.py
    - src/llenergymeasure/results/__init__.py
    - src/llenergymeasure/infra/__init__.py
decisions:
  - "Removed only the state.experiment_state import from cli/experiment.py; left the rest of the dead module intact (lower risk for a cleanup plan)"
  - "Inline field access replaces calculate_efficiency_metrics() — avoids creating a new public function for a dead-code path"
  - "export_aggregated_to_csv and SubprocessRunner left in their implementation files; only removed from public __init__.py surfaces"
metrics:
  duration_min: 4
  completed_date: "2026-02-27"
  tasks_completed: 2
  files_modified: 6
---

# Phase 8.2 Plan 02: Code Cleanup — Broken Imports and Orphaned Exports Summary

**One-liner:** Removed 4 broken v1.x import chains from cli/ modules and 2 orphaned exports from public __init__.py surfaces; test suite 463/465 pass (2 known pre-existing version mismatches unchanged).

## What Was Done

### Task 1: Fix broken imports in cli/ modules

**`cli/experiment.py`** — Removed the top-level broken import block:
```python
# REMOVED:
from llenergymeasure.state.experiment_state import (
    ExperimentState, ExperimentStatus, StateManager, compute_config_hash,
)
```
The module is dead code (not imported by v2.0 `__init__.py`). Removing the top-level import prevents `ImportError` on accidental load. Function bodies referencing these names remain but will never execute at runtime (Python raises `NameError` at call time only).

**`cli/utils.py`** — Removed:
- TYPE_CHECKING import block referencing `state.experiment_state`
- Entire `update_process_state_from_markers()` function (48 lines, dead code with no v2.0 caller)
- `update_process_state_from_markers` from `__all__`
- Dead imports that became unused: `json`, `datetime`, `Path`, `TYPE_CHECKING`

**`cli/results.py`** — Fixed broken `calculate_efficiency_metrics` import:
- Removed `calculate_efficiency_metrics` from aggregation import (function does not exist)
- Replaced call site with inline calculation: `tps = total_tokens / duration_sec`, `tpj = total_tokens / total_energy_j` (with zero-guards)

**`cli/display/results.py`** — Fixed broken lazy `calculate_efficiency_metrics` import in `show_aggregated_result()`:
- Removed `from llenergymeasure.results.aggregation import calculate_efficiency_metrics` lazy import
- Replaced with three inline variables: `tokens_per_second`, `tokens_per_joule`, `joules_per_token` (all with zero-guards)
- Updated table rows to reference local variables

### Task 2: Remove orphaned exports and run tests

**`results/__init__.py`** — Removed `export_aggregated_to_csv` from:
- Import block (removed from `ResultsExporter` import group)
- `__all__` list

**`infra/__init__.py`** — Removed `SubprocessRunner` from:
- Import statement (only `build_subprocess_env` remains)
- `__all__` list

**Test suite:** 463 passed, 2 failed (known pre-existing: `test_public_imports_resolve` and `test_collect_environment_snapshot` — both assert version `2.0.0`, actual is `1.16.0`). No new failures.

## Verification Results

| Check | Result |
|-------|--------|
| `cli/experiment.py` no state.experiment_state ImportError | PASS |
| `cli/utils.py` no `update_process_state_from_markers` | PASS (0 occurrences) |
| `calculate_efficiency_metrics` not in any .py source | PASS (0 files) |
| `export_aggregated_to_csv` not importable from `llenergymeasure.results` | PASS (ImportError) |
| `SubprocessRunner` not importable from `llenergymeasure.infra` | PASS (ImportError) |
| `aggregate_results`, `FileSystemRepository` still importable | PASS |
| `build_subprocess_env` still importable | PASS |
| Full test suite | 463/465 pass (2 pre-existing) |

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Removed unused imports left over from dead function removal**

- **Found during:** Task 1
- **Issue:** After removing `update_process_state_from_markers()`, the imports `json`, `datetime`, `Path`, and `TYPE_CHECKING` became unused in `cli/utils.py`
- **Fix:** Removed all four unused imports
- **Files modified:** `src/llenergymeasure/cli/utils.py`
- **Commit:** 95c969f

### Notes

- `cli/experiment.py` has a second pre-existing broken import (`has_blocking_warnings` from `config.loader`) not in scope for this plan. Deferred: the file is dead code and is not reachable from any active code path.
- `calculate_efficiency_metrics` appears in `results/README.md` (documentation example) — this is a stale doc reference, out of scope for this cleanup plan.

## Self-Check: PASSED

All 6 modified files exist on disk. Both task commits verified:
- `95c969f` — fix(cli): remove broken state.experiment_state imports from v1.x cli modules
- `be6914b` — docs(config): mark CFG requirements complete (includes results/__init__.py and infra/__init__.py changes)
