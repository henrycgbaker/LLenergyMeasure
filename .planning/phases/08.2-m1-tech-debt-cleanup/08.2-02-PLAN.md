---
phase: 08.2-m1-tech-debt-cleanup
plan: "02"
type: execute
wave: 1
depends_on: []
files_modified:
  - src/llenergymeasure/cli/experiment.py
  - src/llenergymeasure/cli/utils.py
  - src/llenergymeasure/cli/results.py
  - src/llenergymeasure/cli/display/results.py
  - src/llenergymeasure/results/__init__.py
  - src/llenergymeasure/infra/__init__.py
autonomous: true
requirements: [CFG-01, CFG-02, CFG-03, CFG-04, CFG-05, CFG-06, CFG-07, CFG-08, CFG-09, CFG-10, CFG-18, CFG-19, CFG-20, CFG-21, CFG-22, CFG-23, CFG-24, CFG-25, CFG-26]
must_haves:
  truths:
    - "cli/experiment.py no longer raises ImportError from deleted state.experiment_state module"
    - "cli/utils.py no longer references non-existent ProcessProgress/ProcessStatus types"
    - "cli/results.py and cli/display/results.py no longer import non-existent calculate_efficiency_metrics function"
    - "export_aggregated_to_csv is removed from results/__init__.py public surface"
    - "SubprocessRunner is removed from infra/__init__.py public surface"
    - "Full test suite passes with no regressions"
  artifacts:
    - path: "src/llenergymeasure/cli/experiment.py"
      provides: "v1.x experiment module with broken import removed"
    - path: "src/llenergymeasure/cli/utils.py"
      provides: "v1.x utils module with dead function and broken imports removed"
    - path: "src/llenergymeasure/cli/results.py"
      provides: "v1.x results module with broken calculate_efficiency_metrics import fixed"
    - path: "src/llenergymeasure/cli/display/results.py"
      provides: "Display module with broken calculate_efficiency_metrics import fixed"
    - path: "src/llenergymeasure/results/__init__.py"
      provides: "Clean public surface without orphaned export_aggregated_to_csv"
    - path: "src/llenergymeasure/infra/__init__.py"
      provides: "Clean public surface without orphaned SubprocessRunner"
  key_links:
    - from: "cli/results.py"
      to: "results/aggregation.py"
      via: "import aggregate_results (kept) — calculate_efficiency_metrics removed"
    - from: "cli/display/results.py"
      to: "results/aggregation.py"
      via: "calculate_efficiency_metrics lazy import removed — replaced with inline field access"
---

# Phase 8.2 Plan 02: Code Cleanup — Broken Imports and Orphaned Exports

## Objective

Fix all broken v1.x import chains in `cli/experiment.py`, `cli/utils.py`, `cli/results.py`, and `cli/display/results.py`, and remove confirmed orphaned exports from `results/__init__.py` and `infra/__init__.py`.

## Context

The M1 audit identified two categories of code issues:

### Broken Imports (4 files)

**`cli/experiment.py` (line 40):**
```python
from llenergymeasure.state.experiment_state import (
    ExperimentState, ExperimentStatus, StateManager, compute_config_hash,
)
```
`state.experiment_state` does not exist. The v2.0 state module is `core.state`. However, `ExperimentStatus` is the v1.x name (v2.0 uses `ExperimentPhase`). This entire file is dead code — the v2.0 CLI `__init__.py` only imports `run.py` and `config_cmd.py`, not `experiment.py`. Fix: remove the broken import block.

**`cli/utils.py` (line 16, line 119):**
- Line 16: `TYPE_CHECKING` import from `state.experiment_state` — safe at runtime but references non-existent module
- Line 119: `from llenergymeasure.state.experiment_state import ProcessProgress, ProcessStatus` — inside `update_process_state_from_markers()` function body. `ProcessProgress` and `ProcessStatus` do not exist in v2.0.
Fix: remove the TYPE_CHECKING import and the entire `update_process_state_from_markers()` function (dead code — no v2.0 caller).

**`cli/results.py` (line 22):**
```python
from llenergymeasure.results.aggregation import aggregate_results, calculate_efficiency_metrics
```
`calculate_efficiency_metrics` does not exist in `results/aggregation.py`. This causes an `ImportError` if the module is ever loaded. Used on line 167. Fix: remove the import and replace the call site with direct field access on the `AggregatedResult` (which is `ExperimentResult` alias).

**`cli/display/results.py` (line 65):**
```python
from llenergymeasure.results.aggregation import calculate_efficiency_metrics
```
Same broken function. Used on line 71. Fix: remove the import and replace with direct field access.

### Orphaned Exports (2 confirmed)

**`export_aggregated_to_csv()` in `results/__init__.py`:**
- Exported in `__all__` and imported from `results/exporters.py`
- No v2.0 caller. No test imports it.
- Fix: remove from `__init__.py` imports and `__all__`. Leave the function in `exporters.py`.

**`SubprocessRunner` in `infra/__init__.py`:**
- Exported in `__all__` and imported from `infra/subprocess.py`
- Not used by v2.0 `_run()` pipeline. `cli/run.py` does not import it.
- Fix: remove from `infra/__init__.py` imports and `__all__`. Leave the class in `subprocess.py`.

### DO NOT REMOVE (active callers confirmed by research)

- `aggregate_results()` — active caller in `cli/results.py` (keep)
- `FlopsEstimator` — active caller in `core/compute_metrics.py` (keep)
- `StateManager` — active caller in `infra/subprocess.py` (keep)

### Existing Interface Context

**`results/aggregation.py` — functions defined:**
```python
def validate_process_completeness(...)  # line 49
def aggregate_results(...)              # line 122 — KEEP
# calculate_efficiency_metrics does NOT exist
```

**`AggregatedResult` is aliased to `ExperimentResult` — available fields:**
```python
result.total_tokens       # int
result.total_energy_j     # float
result.duration_sec       # float
result.avg_tokens_per_second    # float (computed)
result.avg_energy_per_token_j   # float (computed)
```

For `calculate_efficiency_metrics` replacement, use:
- `tokens_per_second` = `result.avg_tokens_per_second` (or `total_tokens / duration_sec`)
- `tokens_per_joule` = `total_tokens / total_energy_j` (guard for zero)
- `joules_per_token` = `total_energy_j / total_tokens` (guard for zero)

---

## Tasks

<task type="auto">
  <name>Fix broken imports in cli/ modules</name>
  <files>src/llenergymeasure/cli/experiment.py, src/llenergymeasure/cli/utils.py, src/llenergymeasure/cli/results.py, src/llenergymeasure/cli/display/results.py</files>
  <action>
    **1. `cli/experiment.py` — remove broken import block (lines 40-45):**

    Remove:
    ```python
    from llenergymeasure.state.experiment_state import (
        ExperimentState,
        ExperimentStatus,
        StateManager,
        compute_config_hash,
    )
    ```

    The file is dead code but removing just the import prevents `ImportError` if accidentally loaded. Do NOT remove the entire file — that is higher risk for a cleanup plan.

    After removing the import, scan the rest of the file for uses of `ExperimentState`, `ExperimentStatus`, `StateManager`, `compute_config_hash`. These names will now be undefined — add `# type: ignore[name-defined]` comments on their usage lines, OR if they are only used in function bodies that are also dead code, leave them (runtime will never reach them since this module is not imported by v2.0 __init__.py).

    Actually, the cleaner approach: since the entire module is dead code, and the broken import is at the module top level (runs on import), removing the import block is sufficient. The function bodies reference these names but will never execute in v2.0. Python will only raise `NameError` at call time, not at import time, so removing the top-level import is enough to prevent the `ImportError`.

    **2. `cli/utils.py` — remove dead TYPE_CHECKING import and dead function:**

    Remove line 16 (TYPE_CHECKING import):
    ```python
    from llenergymeasure.state.experiment_state import ExperimentState, StateManager
    ```

    Remove the entire `update_process_state_from_markers()` function (lines 103-139) which contains the broken function-body import of `ProcessProgress`/`ProcessStatus`. This function has no v2.0 caller.

    Also remove `"update_process_state_from_markers"` from the `__all__` list.

    **3. `cli/results.py` — fix broken `calculate_efficiency_metrics` import:**

    Change line 22 from:
    ```python
    from llenergymeasure.results.aggregation import aggregate_results, calculate_efficiency_metrics
    ```
    To:
    ```python
    from llenergymeasure.results.aggregation import aggregate_results
    ```

    Replace the call site at line 167:
    ```python
    metrics = calculate_efficiency_metrics(aggregated)
    console.print(f"  Throughput: {metrics['tokens_per_second']:.2f} tok/s")
    console.print(f"  Efficiency: {metrics['tokens_per_joule']:.2f} tok/J")
    ```
    With direct field access:
    ```python
    tps = aggregated.total_tokens / aggregated.duration_sec if aggregated.duration_sec > 0 else 0.0
    tpj = aggregated.total_tokens / aggregated.total_energy_j if aggregated.total_energy_j > 0 else 0.0
    console.print(f"  Throughput: {tps:.2f} tok/s")
    console.print(f"  Efficiency: {tpj:.2f} tok/J")
    ```

    **4. `cli/display/results.py` — fix broken `calculate_efficiency_metrics` lazy import:**

    Remove the lazy import at line 65:
    ```python
    from llenergymeasure.results.aggregation import calculate_efficiency_metrics
    ```

    Replace the call site at line 71:
    ```python
    metrics = calculate_efficiency_metrics(result)
    ```
    And update all dict access (`metrics['tokens_per_second']`, `metrics['tokens_per_joule']`, `metrics['joules_per_token']`) with inline calculations:
    ```python
    tokens_per_second = result.total_tokens / result.duration_sec if result.duration_sec > 0 else 0.0
    tokens_per_joule = result.total_tokens / result.total_energy_j if result.total_energy_j > 0 else 0.0
    joules_per_token = result.total_energy_j / result.total_tokens if result.total_tokens > 0 else 0.0
    ```
    Then update the table rows and print statements that reference `metrics[...]` to use the local variables instead.
  </action>
  <verify>
    ```bash
    # Verify no broken imports remain
    python3 -c "import llenergymeasure.cli.experiment" 2>&1 | grep -c "ImportError"
    # Should return 0 (no ImportError)

    python3 -c "from llenergymeasure.cli.results import results_app; print('OK')"
    # Should print OK

    python3 -c "from llenergymeasure.cli.display.results import show_aggregated_result; print('OK')"
    # Should print OK

    # Verify dead function removed from utils
    grep -c "update_process_state_from_markers" src/llenergymeasure/cli/utils.py
    # Should return 0

    # Verify calculate_efficiency_metrics no longer imported
    grep -c "calculate_efficiency_metrics" src/llenergymeasure/cli/results.py src/llenergymeasure/cli/display/results.py
    # Should return 0
    ```
  </verify>
  <done>All broken v1.x imports in cli/ are removed or fixed — no ImportError on module load</done>
</task>

<task type="auto">
  <name>Remove orphaned exports and run tests</name>
  <files>src/llenergymeasure/results/__init__.py, src/llenergymeasure/infra/__init__.py</files>
  <action>
    **1. Remove `export_aggregated_to_csv` from `results/__init__.py`:**

    Remove from the import block:
    ```python
    from llenergymeasure.results.exporters import (
        ResultsExporter,
        export_aggregated_to_csv,   # REMOVE this line
        export_raw_to_csv,
        flatten_model,
    )
    ```

    Remove from `__all__`:
    ```python
    "export_aggregated_to_csv",   # REMOVE this line
    ```

    Leave the function itself in `exporters.py` — it may have external importers who import directly from the module path.

    **2. Remove `SubprocessRunner` from `infra/__init__.py`:**

    Read `src/llenergymeasure/infra/__init__.py` first. Then remove `SubprocessRunner` from the import statement and from `__all__`. Keep `build_subprocess_env` if it is separately used.

    Leave the class itself in `infra/subprocess.py` — M2 Phase 11 may reuse it or its patterns.

    **3. Run the full test suite:**

    ```bash
    cd /home/h.baker@hertie-school.lan/workspace/llm-efficiency-measurement-tool
    python -m pytest tests/ -x -q --tb=short 2>&1 | tail -20
    ```

    All previously passing tests must still pass. The 2 known pre-existing failures (`test_public_imports_resolve` version mismatch, `test_collect_environment_snapshot` version mismatch) are acceptable.

    If any NEW test failures appear, diagnose and fix them before completing this task.
  </action>
  <verify>
    ```bash
    # Verify orphaned exports removed
    python3 -c "from llenergymeasure.results import export_aggregated_to_csv" 2>&1 | grep -c "ImportError"
    # Should return 1 (ImportError — no longer exported)

    python3 -c "from llenergymeasure.infra import SubprocessRunner" 2>&1 | grep -c "ImportError"
    # Should return 1 (ImportError — no longer exported)

    # Verify kept exports still work
    python3 -c "from llenergymeasure.results import aggregate_results, FileSystemRepository; print('OK')"
    python3 -c "from llenergymeasure.infra import build_subprocess_env; print('OK')"

    # Full test suite
    python -m pytest tests/ -x -q --tb=short 2>&1 | tail -5
    # Should show all tests passed (minus 2 known pre-existing failures)
    ```
  </verify>
  <done>Orphaned exports removed from public surface; full test suite passes with no regressions</done>
</task>

## Verification

After both tasks complete:

1. **No broken imports:** `python3 -c "import llenergymeasure.cli.experiment"` succeeds (no ImportError)
2. **No phantom function:** `grep -rn "calculate_efficiency_metrics" src/llenergymeasure/` returns 0 matches
3. **Clean exports:** `export_aggregated_to_csv` and `SubprocessRunner` not in their respective `__init__.py __all__`
4. **Tests pass:** `pytest tests/ -q` — no new failures

## Success Criteria

- [ ] `cli/experiment.py` imports without error (broken `state.experiment_state` import removed)
- [ ] `cli/utils.py` has no `update_process_state_from_markers` function and no `state.experiment_state` import
- [ ] `cli/results.py` imports without error (`calculate_efficiency_metrics` replaced with inline calculation)
- [ ] `cli/display/results.py` imports without error (same fix)
- [ ] `export_aggregated_to_csv` removed from `results/__init__.py` public surface
- [ ] `SubprocessRunner` removed from `infra/__init__.py` public surface
- [ ] Full test suite passes with no regressions (2 known pre-existing failures accepted)

## Output

Plan modifies 6 files:
- `src/llenergymeasure/cli/experiment.py` (MODIFIED — broken import removed)
- `src/llenergymeasure/cli/utils.py` (MODIFIED — dead function + broken imports removed)
- `src/llenergymeasure/cli/results.py` (MODIFIED — broken import fixed, inline calculation)
- `src/llenergymeasure/cli/display/results.py` (MODIFIED — broken import fixed, inline calculation)
- `src/llenergymeasure/results/__init__.py` (MODIFIED — orphaned export removed)
- `src/llenergymeasure/infra/__init__.py` (MODIFIED — orphaned export removed)
