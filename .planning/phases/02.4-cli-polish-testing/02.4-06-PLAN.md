---
phase: 02.4-cli-polish-testing
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - src/llenergymeasure/cli/campaign.py
  - src/llenergymeasure/orchestration/container.py
autonomous: true

must_haves:
  truths:
    - "Campaign shows clear indication of container strategy (ephemeral vs persistent)"
    - "Docker image build progress displayed when images need building"
    - "Container startup status shown in persistent mode"
    - "Per-experiment dispatch status visible during campaign execution"
  artifacts:
    - path: "src/llenergymeasure/cli/campaign.py"
      provides: "Docker lifecycle status display"
      contains: "_display_docker_status"
  key_links:
    - from: "src/llenergymeasure/cli/campaign.py"
      to: "src/llenergymeasure/orchestration/container.py"
      via: "ContainerManager status callbacks"
      pattern: "ContainerManager"
---

<objective>
Add Docker lifecycle output showing container strategy, build progress, startup status, and per-experiment dispatch indicators.

Purpose: Users currently see minimal Docker output. This plan adds clear progress indicators for both ephemeral and persistent container strategies.

Output: Informative Docker lifecycle output during campaign execution.
</objective>

<execution_context>
@/home/h.baker@hertie-school.lan/.claude/get-shit-done/workflows/execute-plan.md
@/home/h.baker@hertie-school.lan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02.4-cli-polish-testing/02.4-CONTEXT.md

@src/llenergymeasure/cli/campaign.py
@src/llenergymeasure/orchestration/container.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Docker strategy status display</name>
  <files>src/llenergymeasure/cli/campaign.py</files>
  <action>
Enhance Docker strategy display at campaign start:

1. Add helper function to display Docker status:

```python
def _display_docker_strategy(
    strategy: Literal["ephemeral", "persistent"],
    backends: list[str],
    use_docker: bool,
) -> None:
    """Display Docker container strategy information."""
    if not use_docker:
        console.print("[green]Execution:[/green] Local (no Docker)")
        return

    strategy_desc = {
        "ephemeral": "Fresh container per experiment (docker compose run --rm)",
        "persistent": "Long-running containers (docker compose up + exec)",
    }

    console.print(f"\n[bold]Docker Container Strategy[/bold]")
    console.print(f"  Strategy: [cyan]{strategy}[/cyan]")
    console.print(f"  {strategy_desc[strategy]}")
    console.print(f"  Backends: {', '.join(backends)}")

    if strategy == "ephemeral":
        console.print("  [dim]Each experiment gets isolated container, auto-cleaned after[/dim]")
    else:
        console.print("  [dim]Containers stay running, faster but may have state carryover[/dim]")
    console.print()
```

2. Call this function in campaign_cmd after strategy resolution:

Replace existing minimal output:
```python
# Old:
console.print(f"[dim]Ephemeral containers: {', '.join(backends_needed)} ...[/dim]")

# New:
_display_docker_strategy(effective_strategy, backends_needed, use_docker)
```
  </action>
  <verify>
Run campaign and verify strategy display appears:
```bash
lem campaign configs/examples/campaign_example.yaml --dry-run
```
Should show strategy type, description, and backend list.
  </verify>
  <done>
Clear Docker strategy indication at campaign start.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Docker image build progress check</name>
  <files>src/llenergymeasure/cli/campaign.py</files>
  <action>
Add image existence check and build prompt:

1. Add function to check if Docker images exist:

```python
def _check_docker_images(backends: list[str]) -> tuple[list[str], list[str]]:
    """Check which Docker images exist and which need building.

    Returns:
        Tuple of (existing_images, missing_images)
    """
    import subprocess

    existing = []
    missing = []

    for backend in backends:
        # Map backend to service name (same in this project)
        service = backend

        # Check if image exists
        result = subprocess.run(
            ["docker", "compose", "images", service, "--quiet"],
            capture_output=True,
            text=True,
        )

        if result.returncode == 0 and result.stdout.strip():
            existing.append(backend)
        else:
            missing.append(backend)

    return existing, missing
```

2. Add function to display build status and optionally trigger build:

```python
def _handle_missing_images(
    missing: list[str],
    yes: bool = False,
) -> bool:
    """Handle missing Docker images.

    Args:
        missing: List of backends with missing images
        yes: Skip confirmation prompts

    Returns:
        True if should proceed, False to abort
    """
    if not missing:
        return True

    console.print(f"\n[yellow]Missing Docker images:[/yellow] {', '.join(missing)}")
    console.print("These need to be built before running experiments.\n")

    if not yes:
        from rich.prompt import Confirm
        build_now = Confirm.ask(
            f"Build images now? (docker compose build {' '.join(missing)})",
            default=True,
        )
        if not build_now:
            console.print("\n[dim]Run manually:[/dim]")
            console.print(f"  docker compose build {' '.join(missing)}")
            return False

    # Show build progress
    console.print(f"\n[bold]Building Docker images...[/bold]")
    for backend in missing:
        console.print(f"  [cyan]◆[/cyan] Building {backend}...")

        result = subprocess.run(
            ["docker", "compose", "build", backend],
            capture_output=False,  # Show output
        )

        if result.returncode != 0:
            console.print(f"  [red]✗[/red] Failed to build {backend}")
            return False

        console.print(f"  [green]✓[/green] {backend} built")

    console.print()
    return True
```

3. Call in campaign_cmd before execution:

```python
if use_docker:
    existing, missing = _check_docker_images(backends_needed)
    if existing:
        console.print(f"[green]✓[/green] Docker images ready: {', '.join(existing)}")
    if missing:
        if not _handle_missing_images(missing, yes=yes):
            raise typer.Abort()
```
  </action>
  <verify>
Test with missing image (rename one temporarily or use fresh docker):
```bash
lem campaign configs/examples/campaign_example.yaml --dry-run
```
Should show image status and prompt to build if missing.
  </verify>
  <done>
Docker image existence check with build prompt and progress display.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add per-experiment dispatch status</name>
  <files>src/llenergymeasure/cli/campaign.py</files>
  <action>
Enhance experiment dispatch output:

1. Add function to display experiment dispatch status:

```python
def _display_experiment_dispatch(
    exp: CampaignExperiment,
    index: int,
    total: int,
    strategy: str,
    backend: str,
) -> None:
    """Display experiment dispatch status."""
    dispatch_type = "run --rm" if strategy == "ephemeral" else "exec"

    console.print(
        f"[{index}/{total}] [cyan]{exp.config_name}[/cyan] "
        f"→ [dim]docker compose {dispatch_type} {backend}[/dim]"
    )
```

2. Update `_run_single_experiment_docker` to show dispatch:

Before the subprocess call, add:
```python
if os.environ.get("LLM_ENERGY_VERBOSITY") != "quiet":
    # Calculate index from manifest if available
    _display_experiment_dispatch(
        exp=exp,
        index=current_index,
        total=total_count,
        strategy=effective_strategy,
        backend=backend,
    )
```

3. Add completion/failure indicator after experiment:

```python
if result.returncode == 0:
    console.print(f"  [green]✓[/green] Completed in {elapsed:.1f}s")
else:
    console.print(f"  [red]✗[/red] Failed (exit code {result.returncode})")
```

4. For persistent mode, add container status before first exec:

```python
if strategy == "persistent" and container_manager:
    console.print(f"[dim]Container {backend}: {container_manager.get_status(backend)}[/dim]")
```
  </action>
  <verify>
Run a small campaign:
```bash
lem campaign configs/examples/pytorch_example.yaml --cycles 2 -n 3
```
Should show per-experiment dispatch with backend and container info.
  </verify>
  <done>
Per-experiment dispatch status showing container strategy and backend routing.
  </done>
</task>

<task type="auto">
  <name>Task 4: Add persistent mode lifecycle status</name>
  <files>
    src/llenergymeasure/cli/campaign.py
    src/llenergymeasure/orchestration/container.py
  </files>
  <action>
Add status output for persistent container mode:

1. In container.py, add status callback support to ContainerManager:

```python
def start_all(self, status_callback: Callable[[str, str], None] | None = None) -> None:
    """Start all configured containers.

    Args:
        status_callback: Optional callback(service, status) for progress
    """
    for service in self.services:
        if status_callback:
            status_callback(service, "starting")

        # Existing start logic...
        result = subprocess.run(...)

        if status_callback:
            status_callback(service, "ready" if result.returncode == 0 else "failed")
```

2. In campaign.py, add callback to display container startup:

```python
def _container_status_callback(service: str, status: str) -> None:
    """Display container startup status."""
    icons = {"starting": "◆", "ready": "✓", "failed": "✗"}
    colors = {"starting": "cyan", "ready": "green", "failed": "red"}

    icon = icons.get(status, "○")
    color = colors.get(status, "white")

    console.print(f"  [{color}]{icon}[/{color}] {service}: {status}")
```

3. Use callback when starting persistent containers:

```python
if effective_strategy == "persistent":
    console.print("\n[bold]Starting containers...[/bold]")
    container_manager.start_all(status_callback=_container_status_callback)
    console.print()
```

4. Add teardown status at campaign end:

```python
if container_manager:
    console.print("\n[bold]Stopping containers...[/bold]")
    container_manager.stop_all(status_callback=_container_status_callback)
```
  </action>
  <verify>
Run campaign with persistent mode:
```bash
lem campaign configs/examples/campaign_example.yaml --container-strategy persistent --cycles 1 -n 3 --yes
```
Should show container startup and teardown status.
  </verify>
  <done>
Persistent mode shows container startup progress and teardown status.
  </done>
</task>

</tasks>

<verification>
1. Campaign shows clear strategy indication (ephemeral vs persistent)
2. Missing images detected and build prompt shown
3. Per-experiment dispatch shows backend and container type
4. Persistent mode shows startup/teardown progress
5. All output respects --quiet flag
</verification>

<success_criteria>
- Docker strategy clearly indicated at campaign start
- Image build progress visible when building
- Per-experiment dispatch shows container routing
- Persistent mode lifecycle (start/stop) visible
- Output suppressed in --quiet mode
</success_criteria>

<output>
After completion, create `.planning/phases/02.4-cli-polish-testing/02.4-06-SUMMARY.md`
</output>
