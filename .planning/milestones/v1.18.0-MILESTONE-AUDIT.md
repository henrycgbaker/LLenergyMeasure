---
milestone: M2 — Study / Sweep
version: v1.18.0
audited: 2026-02-27T21:15:00Z
status: gaps_found
scores:
  requirements: 24/24
  phases: 4/5
  integration: 21/24
  flows: 4/6
gaps:
  requirements:
    - id: "STU-07"
      status: "partial"
      phase: "Phase 11"
      claimed_by_plans: ["11-01-PLAN.md", "11-02-PLAN.md"]
      completed_by_plans: ["11-01-SUMMARY.md", "11-02-SUMMARY.md"]
      verification_status: "passed"
      evidence: "apply_cycles() correct in isolation, but double-called: once in load_study_config() (Phase 9) and again in StudyRunner.run() (Phase 11). Multi-cycle study runs N^2 experiments instead of N."
    - id: "STU-08"
      status: "partial"
      phase: "Phase 11"
      claimed_by_plans: ["11-01-PLAN.md"]
      completed_by_plans: ["11-01-SUMMARY.md"]
      verification_status: "passed"
      evidence: "ManifestWriter.mark_running/completed/failed called correctly, but cycle parameter is hardcoded to 1 in runner.py:323. Manifest entries for cycles 2+ are never transitioned from 'pending'."
    - id: "STU-09"
      status: "partial"
      phase: "Phase 10"
      claimed_by_plans: ["10-01-PLAN.md"]
      completed_by_plans: ["10-01-SUMMARY.md"]
      verification_status: "passed"
      evidence: "Atomic os.replace() writes work correctly. However, top-level StudyManifest.status is never set to 'completed' on successful study finish — only 'interrupted' path is implemented. Readers cannot distinguish a completed study from an in-progress one."
  integration:
    - from: "Phase 9 (load_study_config)"
      to: "Phase 11 (StudyRunner.run)"
      issue: "Double apply_cycles() — StudyRunner.run() re-expands an already-expanded experiment list from StudyConfig. A 2-config × 3-cycle study runs 18 experiments instead of 6."
      severity: "high"
      affected_requirements: ["STU-07"]
    - from: "Phase 11 (StudyRunner._run_one)"
      to: "Phase 10 (ManifestWriter)"
      issue: "Cycle number hardcoded to 1 — manifest entries for cycles 2+ are never marked running/completed/failed."
      severity: "high"
      affected_requirements: ["STU-08"]
    - from: "Phase 12 (_api._run)"
      to: "Phase 10 (ManifestWriter)"
      issue: "No mark_study_completed() call after experiment loop exits cleanly — StudyManifest.status stays 'running' forever on success."
      severity: "low"
      affected_requirements: ["STU-09"]
  flows:
    - flow: "Multi-cycle study execution"
      breaks_at: "StudyRunner.run() double apply_cycles + hardcoded cycle=1"
      severity: "high"
    - flow: "Per-experiment progress display during subprocess execution"
      breaks_at: "_consume_progress_events() discards queue events — print_study_progress() exists but has no caller"
      severity: "low"
tech_debt:
  - phase: 09-grid-expansion-and-studyconfig
    items:
      - "ROADMAP.md shows Phase 9 as '1/2 In Progress' — stale tracking; actually complete"
      - "ROADMAP.md plan checkboxes not ticked for 09-01 and 09-02"
  - phase: 11-subprocess-isolation-and-studyrunner
    items:
      - "SUMMARY.md frontmatter: requirements_completed is empty [] for both 11-01 and 11-02 — should list STU-01 through STU-04, STU-06, STU-07"
      - "runner.py:131 — _consume_progress_events discards events (Phase 12 comment not resolved)"
      - "runner.py:323 — cycle = 1 hardcoded comment says 'deferred to Phase 12 wiring' but Phase 12 did not resolve it"
      - "ExecutionConfig.experiment_timeout_seconds referenced via getattr in runner.py:326 but field does not exist on ExecutionConfig — silently returns None (graceful degradation but phantom field)"
  - phase: 12-integration
    items:
      - "SUMMARY.md frontmatter: requirements_completed is empty [] for all three plans (12-01, 12-02, 12-03)"
      - "print_study_progress() defined in _display.py but never called — orphaned export"
      - "--quiet flag does not suppress gap countdown (documented M2 limitation)"
      - "CLI SIGINT handler sys.exit(130) could bypass Typer error handlers in edge cases (latent, not currently breaking)"
  - phase: 13-documentation-m1-backfill-and-m2-updates
    items:
      - "Phase not started — no plans, no VERIFICATION.md, no SUMMARY.md"
      - "No requirement IDs mapped — documentation-only phase, not a blocker"
---

# M2 Milestone Audit Report — Study / Sweep (v1.18.0)

**Milestone Goal:** `llem run study.yaml` runs a multi-experiment sweep with subprocess isolation, cycle ordering, thermal gaps, and a checkpoint manifest — producing per-experiment `ExperimentResult` files and a `StudyResult` summary.

**Audited:** 2026-02-27
**Status:** gaps_found — 3 integration defects (2 high severity)

---

## Requirements Coverage (24/24 mapped, 21/24 fully wired)

### 3-Source Cross-Reference

| REQ-ID | Phase | VERIFICATION.md | SUMMARY Frontmatter | REQUIREMENTS.md | Final Status |
|--------|-------|-----------------|---------------------|-----------------|--------------|
| CFG-11 | 9 | SATISFIED | listed (09-01) | Complete | **satisfied** |
| CFG-12 | 9 | SATISFIED | listed (09-02) | Complete | **satisfied** |
| CFG-13 | 9 | SATISFIED | listed (09-01) | Complete | **satisfied** |
| CFG-14 | 9 | SATISFIED | listed (09-01) | Complete | **satisfied** |
| CFG-15 | 9 | SATISFIED | listed (09-01) | Complete | **satisfied** |
| CFG-16 | 9 | SATISFIED | listed (09-01) | Complete | **satisfied** |
| STU-08 | 10 | SATISFIED | listed (10-01) | Complete | **partial** — cycle hardcoded to 1 |
| STU-09 | 10 | SATISFIED | listed (10-01) | Complete | **partial** — manifest never marked completed |
| RES-14 | 10 | SATISFIED | listed (10-01) | Complete | **satisfied** |
| RES-NEW-01 | 10 | SATISFIED | listed (10-01) | Complete | **satisfied** |
| STU-01 | 11 | SATISFIED | missing | Complete | **satisfied** (SUMMARY gap only) |
| STU-02 | 11 | SATISFIED | missing | Complete | **satisfied** (SUMMARY gap only) |
| STU-03 | 11 | SATISFIED | missing | Complete | **satisfied** (SUMMARY gap only) |
| STU-04 | 11 | SATISFIED | missing | Complete | **satisfied** (SUMMARY gap only) |
| STU-06 | 11 | SATISFIED | missing | Complete | **satisfied** (SUMMARY gap only) |
| STU-07 | 11 | SATISFIED | missing | Complete | **partial** — double apply_cycles |
| LA-02 | 12 | SATISFIED | missing | Complete | **satisfied** (SUMMARY gap only) |
| LA-05 | 12 | SATISFIED | missing | Complete | **satisfied** (SUMMARY gap only) |
| STU-NEW-01 | 12 | SATISFIED | missing | Complete | **satisfied** (SUMMARY gap only) |
| RES-13 | 12 | SATISFIED | missing | Complete | **satisfied** (SUMMARY gap only) |
| RES-15 | 12 | SATISFIED | missing | Complete | **satisfied** (SUMMARY gap only) |
| CLI-05 | 12 | SATISFIED | missing | Complete | **satisfied** (SUMMARY gap only) |
| CLI-11 | 12 | SATISFIED | missing | Complete | **satisfied** (gap countdown works; progress display orphaned but not required) |
| CM-10 | 12 | SATISFIED | missing | Complete | **satisfied** (SUMMARY gap only) |

**Orphaned requirements:** None. All 24 M2 REQ-IDs appear in at least one phase VERIFICATION.md.

---

## Phase Verification Summary (4/5 phases verified)

| Phase | Status | Score | Notes |
|-------|--------|-------|-------|
| 9: Grid Expansion and StudyConfig | passed | 15/15 | All truths verified; ROADMAP tracking stale |
| 10: Manifest Writer | passed | 7/7 | All truths verified |
| 11: Subprocess Isolation and StudyRunner | passed | 13/13 | All truths verified; SUMMARY frontmatter empty |
| 12: Integration | passed | 13/13 | All truths verified; SUMMARY frontmatter empty |
| 13: Documentation | unverified | — | Not started; no requirements mapped |

---

## Integration Check (21/24 wired, 3 partial)

### Critical Integration Defects

#### Defect 1: Double `apply_cycles()` (HIGH — STU-07)

**Path:** `load_study_config()` (Phase 9) → `StudyConfig.experiments` (already expanded) → `StudyRunner.run()` (Phase 11) calls `apply_cycles()` again

**Impact:** A 2-config × 3-cycle study runs 18 experiments instead of 6.

**Fix:** Remove `apply_cycles()` call from `runner.py` lines 237–245. Iterate `self.study.experiments` directly (already ordered by `load_study_config()`).

#### Defect 2: Cycle number hardcoded to 1 (HIGH — STU-08)

**Path:** `StudyRunner._run_one()` → `manifest.mark_running(config_hash, cycle=1)` → entries for cycles 2+ stay `"pending"` forever

**Impact:** Manifest tracking is wrong for any multi-cycle study. Entries for cycles 2 and 3 never transition.

**Fix:** Track cycle iteration per config_hash (e.g. `defaultdict(int)` incremented per visit, modulo `n_cycles`).

#### Defect 3: Manifest never marked completed (LOW — STU-09)

**Path:** `StudyRunner.run()` / `_api._run()` → experiment loop finishes → no `mark_study_completed()` call → `StudyManifest.status` stays `"running"`

**Impact:** Readers of `manifest.json` cannot distinguish a completed study from one interrupted mid-write.

**Fix:** Add `ManifestWriter.mark_study_completed()` and call it at end of `_api._run()` or `StudyRunner.run()`.

---

## E2E Flow Verification (4/6 complete)

| # | Flow | Status | Break Point |
|---|------|--------|-------------|
| 1 | YAML → load_study_config → StudyConfig → StudyRunner → subprocess → ExperimentResult → StudyResult | **partial** | Double apply_cycles causes wrong experiment count for multi-cycle |
| 2 | CLI study detection → run_study() → _run() dispatcher → StudyRunner or in-process | **complete** | — |
| 3 | Manifest lifecycle: create_study_dir → ManifestWriter → mark transitions → manifest.json | **partial** | cycle=1 hardcoded; no terminal "completed" status |
| 4 | Error flow: multi-backend YAML → run_study_preflight → PreFlightError → exit 1 | **complete** | — |
| 5 | Gap flow: experiment → run_gap(experiment_gap) → next → cycle boundary → run_gap(cycle_gap) | **complete** | — |
| 6 | Interrupt flow: Ctrl+C → SIGINT → SIGTERM child → grace → SIGKILL → manifest.mark_interrupted → exit 130 | **complete** | — |

---

## Tech Debt Summary

### By Phase

**Phase 9: Grid Expansion and StudyConfig**
- ROADMAP.md tracking stale: shows "1/2 In Progress" but phase is fully complete
- Plan checkboxes not ticked in ROADMAP.md

**Phase 11: Subprocess Isolation and StudyRunner**
- SUMMARY frontmatter `requirements_completed: []` — should list STU-01–04, STU-06, STU-07
- `_consume_progress_events()` discards events — "Phase 12" comment not resolved
- `cycle = 1` hardcoded — "deferred to Phase 12" comment not resolved by Phase 12
- `experiment_timeout_seconds` referenced via `getattr` but field missing from `ExecutionConfig` (phantom)

**Phase 12: Integration**
- SUMMARY frontmatter `requirements_completed: []` for all 3 plans
- `print_study_progress()` defined but never called — orphaned
- `--quiet` does not suppress gap countdown (documented M2 limitation)

**Phase 13: Documentation**
- Not started (no requirements mapped — documentation-only, not a blocker)

**Total:** 12 tech debt items across 4 phases

---

_Audited: 2026-02-27_
_Auditor: Claude (gsd-audit-milestone)_
