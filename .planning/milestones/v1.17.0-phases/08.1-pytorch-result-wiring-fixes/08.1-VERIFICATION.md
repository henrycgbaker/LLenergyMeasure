---
phase: 08.1-pytorch-result-wiring-fixes
verified: 2026-02-27T14:00:00Z
status: passed
score: 5/5 must-haves verified
re_verification: false
---

# Phase 08.1: PyTorch Result Wiring Fixes — Verification Report

**Phase Goal:** Fix all 4 broken E2E flows caused by PyTorchBackend._build_result() field wiring
bugs, add extra="forbid" to prevent recurrence, and wire timeseries co-location in CLI.
**Verified:** 2026-02-27
**Status:** PASSED
**Re-verification:** No — initial verification

---

## Goal Achievement

### Observable Truths

| # | Truth | Status | Evidence |
|---|-------|--------|----------|
| 1 | ExperimentResult.timeseries is a str (not None) after PyTorchBackend.run() when timeseries data exists | VERIFIED | `pytorch.py:782` — `timeseries=timeseries_path` (correct kwarg); `test_build_result_populates_timeseries_field` passes |
| 2 | ExperimentResult.effective_config contains the experiment's resolved config dict (model key is not 'unknown') | VERIFIED | `pytorch.py:783` — `effective_config=config.model_dump()`; `test_build_result_populates_effective_config` asserts `result.effective_config.get("model") == "gpt2"` |
| 3 | ExperimentResult.baseline_power_w and energy_adjusted_j are populated from EnergyBreakdown data | VERIFIED | `pytorch.py:784-785` — both extracted from `energy_breakdown` before constructor call; `test_build_result_propagates_baseline_fields` passes |
| 4 | ExperimentResult rejects unrecognised kwargs with ValidationError (extra='forbid') | VERIFIED | `experiment.py:259` — `model_config = {"frozen": True, "extra": "forbid"}`; `test_experiment_result_rejects_unknown_kwargs` passes |
| 5 | Timeseries parquet sidecar is co-located with result.json in the same output subdirectory | VERIFIED | `cli/run.py:195-199` — `ts_source` constructed from `result.timeseries`, passed as `timeseries_source=ts_source` to `result.save()`, stale flat file unlinked after copy |

**Score:** 5/5 truths verified

---

### Required Artifacts

| Artifact | Expected | Status | Details |
|----------|----------|--------|---------|
| `src/llenergymeasure/core/backends/pytorch.py` | Fixed `_build_result()` with correct field wiring | VERIFIED | Lines 782-785: `timeseries=`, `effective_config=`, `baseline_power_w=`, `energy_adjusted_j=` all present. Committed in `bb64794`. |
| `src/llenergymeasure/domain/experiment.py` | ExperimentResult with extra=forbid | VERIFIED | Line 259: `model_config = {"frozen": True, "extra": "forbid"}`. Committed in `bb64794`. |
| `src/llenergymeasure/cli/run.py` | Timeseries co-location via timeseries_source | VERIFIED | Lines 194-200: `ts_source` path constructed, passed to `result.save()`, stale file unlinked. Committed in `c0d7a42`. |
| `tests/unit/test_measurement_integration.py` | 3 tests for `_build_result` field wiring | VERIFIED | Lines 481-534: `test_build_result_populates_timeseries_field`, `test_build_result_populates_effective_config`, `test_build_result_propagates_baseline_fields`. All pass. |
| `tests/unit/test_experiment_result_v2.py` | Test for extra=forbid rejection | VERIFIED | Lines 366-369: `test_experiment_result_rejects_unknown_kwargs` — raises `ValidationError` with `match="Extra inputs are not permitted"`. Passes. |

---

### Key Link Verification

| From | To | Via | Status | Details |
|------|----|-----|--------|---------|
| `pytorch.py` | `domain/experiment.py` | ExperimentResult constructor kwargs | WIRED | `timeseries=`, `effective_config=`, `baseline_power_w=`, `energy_adjusted_j=` all use correct field names matching ExperimentResult fields |
| `cli/run.py` | `domain/experiment.py` | `result.save(output_dir, timeseries_source=ts_source)` | WIRED | `timeseries_source` kwarg passed; `ts_source` correctly derived as `output_dir / result.timeseries` when timeseries is not None |

---

### Requirements Coverage

| Requirement | Source Plan | Description | Status | Evidence |
|-------------|-------------|-------------|--------|----------|
| RES-06 | 08.1-01-PLAN.md | `baseline_power_w`, `energy_adjusted_j`, `energy_per_device_j` on ExperimentResult | SATISFIED | `pytorch.py:784-785` extract from `energy_breakdown` before constructor; test `test_build_result_propagates_baseline_fields` verifies. `energy_per_device_j` is an ExperimentResult field (multi-GPU path, out of scope for single-GPU PyTorch) — not a gap. |
| RES-16 | 08.1-01-PLAN.md | Output always in subdirectory `{name}_{timestamp}/result.json` + `timeseries.parquet` co-located | SATISFIED | `effective_config=config.model_dump()` fixes directory naming; CLI wiring fixes co-location. Both verified by tests and code inspection. |
| CM-16 | 08.1-01-PLAN.md | Timeseries: 1 Hz sidecar `timeseries.parquet` reachable from `ExperimentResult.timeseries` | SATISFIED | Kwarg name fixed from `timeseries_path=` to `timeseries=`; `test_build_result_populates_timeseries_field` proves the field is now populated. |

No orphaned requirements — all 3 IDs declared in plan frontmatter map directly to REQUIREMENTS.md Phase 8.1 traceability table.

---

### Anti-Patterns Found

| File | Line | Pattern | Severity | Impact |
|------|------|---------|----------|--------|
| `pytorch.py` | 337, 347, 352 | "M1 placeholder" comments on prompt generation method | Info | Pre-existing from `8507280` — not introduced by this phase, unrelated to result wiring |

No blockers or warnings from this phase's changes. The "M1 placeholder" comments are pre-existing on prompt generation code, not on the result assembly code changed in this phase.

---

### Test Results

**Phase-specific tests (54 tests across 2 files):** 54 passed, 0 failed.

**Full unit suite (465 collected):**
- 463 passed
- 2 pre-existing failures (documented in SUMMARY.md, out of scope):
  - `test_api.py::test_public_imports_resolve` — asserts `__version__ == "2.0.0"`, actual is `1.16.0`
  - `test_environment_snapshot.py::test_collect_environment_snapshot` — same version string mismatch

Neither failure is caused by this phase. All 434 in-scope unit tests pass.

---

### Human Verification Required

None — all 5 truths are verifiable programmatically via code inspection and passing unit tests.

---

### Verified Commits

| Commit | Type | Content |
|--------|------|---------|
| `bb64794` | fix(results) | `pytorch.py` 4-line wiring fix + `experiment.py` extra=forbid + `test_experiment_result_v2.py` rejection test |
| `c0d7a42` | fix(cli) | `cli/run.py` timeseries co-location + `test_measurement_integration.py` 3 wiring tests |

Both commits exist in git history and match their declared file sets.

---

## Summary

All 5 must-haves verified. Phase goal is achieved.

The 4 broken E2E flows from the M1 audit are all fixed:
1. `timeseries=` kwarg now matches the ExperimentResult field name — timeseries round-trip works.
2. `effective_config=config.model_dump()` — output directory uses real model name, not "unknown".
3. `baseline_power_w` and `energy_adjusted_j` extracted from `EnergyBreakdown` — baseline display works.
4. CLI passes `timeseries_source` to `result.save()` — parquet co-located with `result.json`.

The structural guard (`extra="forbid"`) is in place to catch any future kwarg name mismatches at construction time.

---

_Verified: 2026-02-27_
_Verifier: Claude (gsd-verifier)_
