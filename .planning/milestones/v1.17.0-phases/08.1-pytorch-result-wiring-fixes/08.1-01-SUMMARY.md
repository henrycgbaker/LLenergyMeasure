---
phase: 08.1-pytorch-result-wiring-fixes
plan: 01
subsystem: results
tags: [pydantic, pytorch, timeseries, parquet, energy-breakdown, cli]

# Dependency graph
requires:
  - phase: 04-codebase-audit
    provides: M1 audit identifying 4 broken E2E flows in PyTorchBackend._build_result()
provides:
  - Fixed _build_result() field wiring in PyTorchBackend (timeseries, effective_config, baseline fields)
  - ExperimentResult with extra="forbid" preventing silent field drops
  - CLI timeseries co-location (parquet alongside result.json in subdirectory)
  - 4 targeted regression tests proving each fix
affects: [09-grid-expansion, 10-manifest-writer, 12-integration]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "extra='forbid' on Pydantic models to surface kwarg name mismatches at construction time"
    - "Extract breakdown fields explicitly from EnergyBreakdown before passing to result constructor"

key-files:
  created:
    - tests/unit/test_experiment_result_v2.py (new test added)
    - tests/unit/test_measurement_integration.py (3 new tests added)
  modified:
    - src/llenergymeasure/core/backends/pytorch.py
    - src/llenergymeasure/domain/experiment.py
    - src/llenergymeasure/cli/run.py

key-decisions:
  - "Add extra='forbid' only to ExperimentResult, not RawProcessResult — ExperimentResult is the user-visible output where silent drops are most dangerous"
  - "ts_source.unlink(missing_ok=True) cleans up flat timeseries after co-location copy — safe because save_result() already copied it into the subdirectory"

patterns-established:
  - "Pydantic extra='forbid': Always add to user-visible output models to surface field name mismatches immediately"
  - "_build_result() wiring: Extract nullable fields from nested models before passing to constructor"

requirements-completed: [RES-06, RES-16, CM-16]

# Metrics
duration: 3min
completed: 2026-02-27
---

# Phase 08.1 Plan 01: PyTorch Result Wiring Fixes Summary

**Fixed 4 silent field drops in PyTorchBackend._build_result() — timeseries, effective_config, baseline_power_w, energy_adjusted_j — plus extra="forbid" guard and CLI timeseries co-location**

## Performance

- **Duration:** 3 min
- **Started:** 2026-02-27T12:12:02Z
- **Completed:** 2026-02-27T12:14:38Z
- **Tasks:** 2
- **Files modified:** 5

## Accomplishments
- Fixed `timeseries_path=` → `timeseries=` kwarg mismatch (CM-16) — timeseries field now populated
- Added `effective_config=config.model_dump()` — output directory now uses real model name instead of "unknown"
- Added `baseline_power_w` and `energy_adjusted_j` extraction from `EnergyBreakdown` (RES-06)
- Added `extra="forbid"` to `ExperimentResult` — future kwarg name mismatches raise `ValidationError` immediately
- Wired `timeseries_source` in CLI `run.py` — parquet file now co-located with `result.json` in subdirectory
- Added 4 regression tests (1 for extra=forbid, 3 for field wiring)

## Task Commits

Each task was committed atomically:

1. **Task 1: Fix _build_result() wiring and add extra="forbid"** - `bb64794` (fix)
2. **Task 2: Wire timeseries co-location in CLI and add wiring tests** - `c0d7a42` (fix)

**Plan metadata:** TBD (docs: complete plan)

## Files Created/Modified
- `src/llenergymeasure/core/backends/pytorch.py` - Fixed 3 field wiring bugs in `_build_result()`
- `src/llenergymeasure/domain/experiment.py` - Added `extra="forbid"` to `ExperimentResult.model_config`
- `src/llenergymeasure/cli/run.py` - Pass `timeseries_source` to `result.save()`, clean up flat file
- `tests/unit/test_experiment_result_v2.py` - Added `test_experiment_result_rejects_unknown_kwargs`
- `tests/unit/test_measurement_integration.py` - Added 3 `_build_result` wiring tests

## Decisions Made
- `extra="forbid"` added only to `ExperimentResult` (user-visible output), not `RawProcessResult`. The user-visible model is where silent drops cause visible bugs; RawProcessResult is internal.
- `ts_source.unlink(missing_ok=True)` after co-location: safe because `save_result()` copies the file before we delete the original.

## Deviations from Plan

None — plan executed exactly as written.

## Issues Encountered

Two pre-existing test failures found (not caused by these changes):
- `test_public_imports_resolve` in `test_api.py` — checks `__version__ == "2.0.0"`, actual is `1.16.0`
- `test_collect_environment_snapshot` in `test_environment_snapshot.py` — same version mismatch

Both are pre-existing and out of scope for this plan.

## User Setup Required

None — no external service configuration required.

## Next Phase Readiness
- All 5 M1 audit fix criteria met
- `ExperimentResult` now defensively rejects unknown kwargs — future backend additions are safer
- Timeseries round-trip fully wired end-to-end
- Ready to continue M2 work (Phase 09 Plan 03)

## Self-Check: PASSED

All files present and all commits verified:
- `src/llenergymeasure/core/backends/pytorch.py` — FOUND
- `src/llenergymeasure/domain/experiment.py` — FOUND
- `src/llenergymeasure/cli/run.py` — FOUND
- `tests/unit/test_measurement_integration.py` — FOUND
- `tests/unit/test_experiment_result_v2.py` — FOUND
- Commit `bb64794` — FOUND
- Commit `c0d7a42` — FOUND

---
*Phase: 08.1-pytorch-result-wiring-fixes*
*Completed: 2026-02-27*
