---
phase: 01-measurement-foundations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - src/llenergymeasure/__init__.py
  - src/llenergymeasure/cli/__init__.py
  - src/llenergymeasure/constants.py
  - src/llenergymeasure/progress.py
  - src/llenergymeasure/results/bootstrap.py
  - src/llenergymeasure/core/inference_backends/adapters.py
  - src/llenergymeasure/core/inference_backends/shared.py
  - src/llenergymeasure/config/naming.py
  - src/llenergymeasure/config/campaign_config.py
  - src/llenergymeasure/config/speculative.py
  - src/llenergymeasure/core/traffic.py
  - src/llenergymeasure/cli/batch.py
  - src/llenergymeasure/cli/campaign.py
  - src/llenergymeasure/cli/doctor.py
  - src/llenergymeasure/cli/init_cmd.py
  - src/llenergymeasure/cli/listing.py
  - src/llenergymeasure/cli/resume.py
  - src/llenergymeasure/cli/schedule.py
  - src/llenergymeasure/orchestration/campaign.py
  - src/llenergymeasure/orchestration/container.py
  - src/llenergymeasure/orchestration/grid.py
  - src/llenergymeasure/orchestration/manifest.py
  - src/llenergymeasure/notifications/webhook.py
autonomous: true
requirements:
  - INF-01
  - INF-02
  - INF-03
  - INF-04
  - INF-05

must_haves:
  truths:
    - "pip install -e '.[pytorch]' installs cleanly from the new hatchling-based pyproject.toml"
    - "llem --help responds; lem is absent from installed entry points"
    - "import llenergymeasure succeeds and __version__ returns '2.0.0'"
    - "All confirmed dead code files are removed from the repository"
  artifacts:
    - path: "pyproject.toml"
      provides: "Hatchling build system with correct deps, extras, and llem entry point"
      contains: "hatchling"
    - path: "src/llenergymeasure/__init__.py"
      provides: "Package init with version 2.0.0"
      contains: '__version__ = "2.0.0"'
    - path: "src/llenergymeasure/cli/__init__.py"
      provides: "Stripped CLI with only experiment and config commands"
  key_links:
    - from: "pyproject.toml"
      to: "src/llenergymeasure/cli:app"
      via: "[project.scripts] llem entry point"
      pattern: 'llem.*=.*"llenergymeasure\\.cli:app"'
---

<objective>
Rewrite the build system from Poetry to hatchling, set up correct dependency extras,
configure the llem entry point (removing lem), delete all confirmed dead code, and
update the package version to 2.0.0.

Purpose: Establishes the installable package foundation that every subsequent phase builds on.
Output: Clean pyproject.toml, dead code removed, package installs and imports correctly.
</objective>

<execution_context>
@/home/h.baker@hertie-school.lan/.claude/get-shit-done/workflows/execute-plan.md
@/home/h.baker@hertie-school.lan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@pyproject.toml
@src/llenergymeasure/__init__.py
@src/llenergymeasure/cli/__init__.py
@src/llenergymeasure/constants.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite pyproject.toml from Poetry to hatchling with correct deps and extras</name>
  <files>pyproject.toml</files>
  <action>
Rewrite pyproject.toml from Poetry build system to hatchling/hatch. Keep all existing tool configs (ruff, mypy, pytest, commitizen).

Build system section:
```toml
[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"
```

Project metadata — use `[project]` table (PEP 621), NOT `[tool.poetry]`:
- name = "llenergymeasure"
- version = "2.0.0"
- requires-python = ">=3.10"
- description, authors, readme as before

Base dependencies (`[project.dependencies]`):
- pydantic>=2.0
- typer>=0.9
- pyyaml>=6.0
- platformdirs>=3.0
- nvidia-ml-py>=12.0
- pyarrow>=14.0
- tqdm>=4.66

These are the ONLY base deps (INF-02). Remove: torch, loguru, codecarbon, datasets, schedule,
python-dotenv, numpy, python-on-whales, questionary, httpx, accelerate, bitsandbytes, calflops,
peft, transformers from base deps. Some move to extras.

Optional dependency extras (`[project.optional-dependencies]`):
- pytorch = ["torch>=2.5", "transformers>=4.49", "accelerate>=1.4", "bitsandbytes>=0.45", "calflops>=0.2", "peft>=0.18"]
- vllm = ["vllm>=0.6"]
- tensorrt = ["tensorrt-llm>=0.12"]
- zeus = ["zeus-ml>=0.10"]
- codecarbon = ["codecarbon>=2.8"]
- webhooks = ["httpx>=0.23"]
- dev = ["pytest>=8.0", "pytest-cov>=4.0", "ruff>=0.8", "mypy>=1.0", "types-pyyaml>=6.0.12"]

Do NOT create an `[all]` extra (INF-04 — vLLM + TRT are process-incompatible).
Remove the existing `all`, `api`, `onnxrt` extras.

Entry point — `[project.scripts]`:
```toml
[project.scripts]
llem = "llenergymeasure.cli:app"
```
Only `llem`. Do NOT include `lem` (INF-05). Remove the old `llenergymeasure` entry point too.

Hatch build config:
```toml
[tool.hatch.build.targets.wheel]
packages = ["src/llenergymeasure"]
```

Keep all existing [tool.ruff], [tool.mypy], [tool.pytest.ini_options], [tool.commitizen] sections.
Update commitizen version_files to use the new pyproject location if needed.
  </action>
  <verify>
Run: `python -c "import tomllib; t = tomllib.load(open('pyproject.toml','rb')); assert t['build-system']['build-backend'] == 'hatchling.build'; assert 'llem' in t['project']['scripts']; assert 'lem' not in t['project'].get('scripts',{}); assert 'all' not in t['project'].get('optional-dependencies',{}); print('OK')"` — prints OK.
  </verify>
  <done>
pyproject.toml uses hatchling build, declares only base deps per INF-02, has [pytorch] [vllm] [tensorrt] [zeus] [codecarbon] [webhooks] extras per INF-03, no [all] extra per INF-04, llem is the only script entry point per INF-05, lem is absent.
  </done>
</task>

<task type="auto">
  <name>Task 2: Delete dead code and strip CLI to skeleton</name>
  <files>
    src/llenergymeasure/progress.py
    src/llenergymeasure/results/bootstrap.py
    src/llenergymeasure/core/inference_backends/adapters.py
    src/llenergymeasure/core/inference_backends/shared.py
    src/llenergymeasure/config/naming.py
    src/llenergymeasure/config/campaign_config.py
    src/llenergymeasure/config/speculative.py
    src/llenergymeasure/core/traffic.py
    src/llenergymeasure/cli/batch.py
    src/llenergymeasure/cli/campaign.py
    src/llenergymeasure/cli/doctor.py
    src/llenergymeasure/cli/init_cmd.py
    src/llenergymeasure/cli/listing.py
    src/llenergymeasure/cli/resume.py
    src/llenergymeasure/cli/schedule.py
    src/llenergymeasure/orchestration/campaign.py
    src/llenergymeasure/orchestration/container.py
    src/llenergymeasure/orchestration/grid.py
    src/llenergymeasure/orchestration/manifest.py
    src/llenergymeasure/notifications/webhook.py
    src/llenergymeasure/cli/__init__.py
    src/llenergymeasure/__init__.py
    src/llenergymeasure/constants.py
  </files>
  <action>
**Delete the following dead code files** (git rm):
- src/llenergymeasure/progress.py (250 lines — zero imports)
- src/llenergymeasure/results/bootstrap.py (118 lines — zero imports)
- src/llenergymeasure/core/inference_backends/adapters.py (209 lines — zero imports)
- src/llenergymeasure/core/inference_backends/shared.py (248 lines — dead utilities)
- src/llenergymeasure/config/naming.py (304 lines — zero imports)
- src/llenergymeasure/config/campaign_config.py (524 lines — campaign dead)
- src/llenergymeasure/config/speculative.py (105 lines — zero imports)
- src/llenergymeasure/core/traffic.py (142 lines — zero imports)

**Delete dead CLI command files** (git rm):
- src/llenergymeasure/cli/batch.py (133 lines)
- src/llenergymeasure/cli/campaign.py (1754 lines)
- src/llenergymeasure/cli/doctor.py (236 lines)
- src/llenergymeasure/cli/init_cmd.py (405 lines)
- src/llenergymeasure/cli/listing.py (105 lines)
- src/llenergymeasure/cli/resume.py (178 lines)
- src/llenergymeasure/cli/schedule.py (298 lines)

**Delete dead orchestration files** (git rm):
- src/llenergymeasure/orchestration/campaign.py (585 lines)
- src/llenergymeasure/orchestration/container.py (253 lines)
- src/llenergymeasure/orchestration/grid.py (363 lines)
- src/llenergymeasure/orchestration/manifest.py (194 lines)

**Delete dead notifications** (git rm):
- src/llenergymeasure/notifications/ (entire directory)

**Rewrite cli/__init__.py** — strip to skeleton:
- Remove imports of deleted command modules (batch, campaign, doctor, init_cmd, listing, resume, schedule)
- Remove the entire `_register_commands()` function and its call
- Keep: app creation, config_app subcommand, version_callback
- Update app name from "lem" to "llem"
- Remove Rich console import — use plain print instead. (Rich is not a base dep in v2.0.)
- Remove dotenv import and load_dotenv() call (python-dotenv removed from deps)
- Remove the results_app import (results display is Phase 6+)
- Keep experiment command registration — `app.command("experiment")(experiment.experiment_cmd)` — but only if experiment.py import works. If it would fail due to missing deps at import time, wrap in try/except or defer to Phase 7.
- For now, the CLI should be a minimal skeleton: `llem --version` works, `llem --help` works. The `run` and `config` commands will be added in Phase 7.

**Update __init__.py:**
- Set `__version__ = "2.0.0"` (currently "1.0.0")

**Clean up constants.py:**
- Remove PRESETS dict (large, campaign/preset-oriented, dead in v2.0)
- Remove DEPRECATED_CLI_FLAGS dict
- Remove get_preset_metadata(), get_preset_config(), EXPERIMENT_PRESETS alias
- Remove is_cli_flag_deprecated(), get_deprecation_info()
- Keep: DEFAULT_RESULTS_DIR, RAW_RESULTS_SUBDIR, AGGREGATED_RESULTS_SUBDIR, experiment defaults, schema version, state management constants, timeouts
- Update SCHEMA_VERSION to "2.0.0"

**Remove any CLAUDE.md files** that reference deleted modules (in cli/, orchestration/, state/ etc.). These are internal dev docs for the old structure and will be stale.
  </action>
  <verify>
Run: `python -c "import llenergymeasure; print(llenergymeasure.__version__)"` — prints "2.0.0".
Run: `git diff --stat HEAD | grep 'delete mode'` — shows 20+ deleted files.
Run: `python -c "from pathlib import Path; dead = ['progress.py','results/bootstrap.py','core/inference_backends/adapters.py','config/naming.py','config/campaign_config.py','config/speculative.py','core/traffic.py','cli/batch.py','cli/campaign.py']; base = Path('src/llenergymeasure'); assert all(not (base/f).exists() for f in dead), 'Dead code still exists'; print('All dead code removed')"` — confirms deletion.
  </verify>
  <done>
All confirmed dead code files deleted. CLI stripped to skeleton (llem --version works). __version__ is "2.0.0". Constants cleaned of presets and deprecated flags. Total lines removed: 5,000+ lines of dead/campaign code.
  </done>
</task>

</tasks>

<verification>
1. `python -c "import tomllib; t=tomllib.load(open('pyproject.toml','rb')); print(t['build-system']['build-backend'])"` prints "hatchling.build"
2. `python -c "import llenergymeasure; print(llenergymeasure.__version__)"` prints "2.0.0"
3. None of the deleted files exist on disk
4. `grep -r "lem " pyproject.toml` shows only "llem", not "lem" as a standalone entry point
</verification>

<success_criteria>
- pyproject.toml uses hatchling, declares correct base deps and extras, no [all] extra
- llem is the only entry point; lem is gone
- __version__ == "2.0.0"
- 20+ dead code files deleted from repository
- CLI skeleton responds to --version and --help
</success_criteria>

<output>
After completion, create `.planning/phases/01-measurement-foundations/01-01-SUMMARY.md`
</output>
