---
phase: 02.2-campaign-execution-model
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/llenergymeasure/cli/campaign.py
  - src/llenergymeasure/cli/experiment.py
  - src/llenergymeasure/orchestration/launcher.py
autonomous: true

must_haves:
  truths:
    - "Experiments inside campaigns display 'Part of campaign X, cycle Y/Z' instead of 'single cycle' warning"
    - "Single cycle warning suppressed when LEM_CAMPAIGN_ID environment variable is set"
    - "Experiment --cycles flag removed (experiments are atomic, campaigns own repetition)"
  artifacts:
    - path: "src/llenergymeasure/cli/campaign.py"
      provides: "Campaign context propagation via environment variables"
      contains: "LEM_CAMPAIGN_ID"
    - path: "src/llenergymeasure/cli/experiment.py"
      provides: "Campaign context detection and cycle warning suppression"
      contains: "os.environ.get.*LEM_CAMPAIGN_ID"
    - path: "src/llenergymeasure/orchestration/launcher.py"
      provides: "Campaign context display in subprocess"
      contains: "LEM_CAMPAIGN_ID"
  key_links:
    - from: "src/llenergymeasure/cli/campaign.py"
      to: "_run_single_experiment"
      via: "environment variables in subprocess call"
      pattern: "LEM_CAMPAIGN_ID.*LEM_CYCLE.*LEM_TOTAL_CYCLES"
    - from: "src/llenergymeasure/cli/experiment.py"
      to: "cycle warning display"
      via: "environment variable check"
      pattern: "if.*LEM_CAMPAIGN_ID"
---

<objective>
Propagate campaign context to experiments via environment variables and suppress CI warnings for campaign experiments.

Purpose: Experiments running as part of a campaign currently display misleading "single cycle" warnings because they don't know they're part of a multi-cycle campaign. This plan fixes that by passing campaign context via environment variables and updating the experiment CLI to detect and display appropriate messaging.

Output: Campaign context (ID, cycle, total cycles) flows to experiments; CI warnings suppressed for campaign experiments; --cycles flag removed from experiment CLI.
</objective>

<execution_context>
@/home/h.baker@hertie-school.lan/.claude/get-shit-done/workflows/execute-plan.md
@/home/h.baker@hertie-school.lan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02.2-CONTEXT.md

@src/llenergymeasure/cli/campaign.py
@src/llenergymeasure/cli/experiment.py
@src/llenergymeasure/orchestration/launcher.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Pass campaign context via environment variables in campaign.py</name>
  <files>src/llenergymeasure/cli/campaign.py</files>
  <action>
Update `_run_single_experiment()` to pass campaign context as environment variables:

1. Add to the subprocess environment (both Docker and local paths):
   - `LEM_CAMPAIGN_ID`: The campaign's campaign_id
   - `LEM_CAMPAIGN_NAME`: The campaign's name
   - `LEM_CYCLE`: Current cycle (1-indexed for display, e.g., "2")
   - `LEM_TOTAL_CYCLES`: Total cycles in campaign (e.g., "3")

2. For Docker dispatch (`_build_docker_command()`), add `-e` flags to pass env vars:
   ```python
   cmd = [
       "docker", "compose", "run", "--rm",
       "-e", f"LEM_CAMPAIGN_ID={campaign.campaign_id}",
       "-e", f"LEM_CAMPAIGN_NAME={campaign.campaign_name}",
       "-e", f"LEM_CYCLE={cycle_num}",
       "-e", f"LEM_TOTAL_CYCLES={total_cycles}",
       backend,
       ...
   ]
   ```

3. For local dispatch, env vars are already in `subprocess_env` - just add the new ones before the subprocess.run() call.

4. Update function signature of `_build_docker_command()` to accept campaign context:
   ```python
   def _build_docker_command(
       backend: str,
       config_path: str,
       dataset: str | None,
       sample_size: int | None,
       results_dir: Path | None,
       campaign_context: dict[str, str] | None = None,  # NEW
   ) -> list[str]:
   ```
  </action>
  <verify>
Grep for LEM_CAMPAIGN_ID in campaign.py:
```bash
grep -n "LEM_CAMPAIGN" src/llenergymeasure/cli/campaign.py
```
Should show environment variable assignments in both Docker and local paths.
  </verify>
  <done>Campaign context environment variables (LEM_CAMPAIGN_ID, LEM_CAMPAIGN_NAME, LEM_CYCLE, LEM_TOTAL_CYCLES) are passed to experiment subprocesses in both Docker and local execution modes.</done>
</task>

<task type="auto">
  <name>Task 2: Detect campaign context and suppress CI warning in experiment.py</name>
  <files>src/llenergymeasure/cli/experiment.py</files>
  <action>
Update `experiment_cmd()` to detect campaign context and modify behaviour:

1. At the start of `experiment_cmd()`, detect campaign context:
   ```python
   # Detect if running as part of a campaign
   campaign_context = {
       "campaign_id": os.environ.get("LEM_CAMPAIGN_ID"),
       "campaign_name": os.environ.get("LEM_CAMPAIGN_NAME"),
       "cycle": os.environ.get("LEM_CYCLE"),
       "total_cycles": os.environ.get("LEM_TOTAL_CYCLES"),
   }
   in_campaign = campaign_context["campaign_id"] is not None
   ```

2. Replace the "single cycle" warning logic (around line 663-667):
   ```python
   # OLD CODE:
   # else:
   #     console.print(
   #         "  [dim]Single cycle:[/dim] confidence intervals and robustness "
   #         "metrics require >= 3 cycles (--cycles 3)"
   #     )

   # NEW CODE:
   if effective_cycles > 1:
       source = "CLI" if cycles is not None else "config"
       console.print(f"  [cyan]Multi-cycle mode:[/cyan] {effective_cycles} cycles ({source})")
   elif in_campaign:
       # Running as part of campaign - don't show single cycle warning
       # Campaign orchestrates cycles, not individual experiments
       cycle = campaign_context["cycle"]
       total = campaign_context["total_cycles"]
       console.print(
           f"  [cyan]Part of campaign:[/cyan] {campaign_context['campaign_name']} "
           f"(cycle {cycle}/{total})"
       )
   else:
       console.print(
           "  [dim]Single cycle:[/dim] confidence intervals and robustness "
           "metrics require >= 3 cycles (--cycles 3)"
       )
   ```

3. Remove the `--cycles` CLI flag from `experiment_cmd()`. Experiments are atomic - cycles are owned by campaigns. Remove:
   - The `cycles` parameter from the function signature
   - Any references to `cycles` in the function body (except `effective_cycles` which should now always be 1)
   - Update `effective_cycles = cycles if cycles is not None else config.num_cycles` to `effective_cycles = config.num_cycles` (which defaults to 1)

4. Keep `config.num_cycles` in the config model (for backwards compatibility with existing configs) but ignore it in experiment CLI - it's now a campaign-level concern only.
  </action>
  <verify>
```bash
# Verify --cycles removed from experiment command
python -c "from llenergymeasure.cli.experiment import experiment_cmd; import inspect; sig = inspect.signature(experiment_cmd); print([p for p in sig.parameters if 'cycle' in p.lower()])"
# Should output [] (empty list)

# Verify campaign context detection added
grep -n "LEM_CAMPAIGN_ID" src/llenergymeasure/cli/experiment.py
# Should show detection logic
```
  </verify>
  <done>Experiment CLI detects campaign context from environment variables, displays "Part of campaign X (cycle Y/Z)" instead of single cycle warning, and --cycles flag is removed (experiments are atomic).</done>
</task>

<task type="auto">
  <name>Task 3: Display campaign context in launcher subprocess output</name>
  <files>src/llenergymeasure/orchestration/launcher.py</files>
  <action>
Update the launcher to display campaign context at startup if present:

1. In the main entry point of launcher.py (likely `main()` or similar), add campaign context detection:
   ```python
   # At start of experiment execution
   campaign_id = os.environ.get("LEM_CAMPAIGN_ID")
   if campaign_id:
       campaign_name = os.environ.get("LEM_CAMPAIGN_NAME", "unknown")
       cycle = os.environ.get("LEM_CYCLE", "?")
       total = os.environ.get("LEM_TOTAL_CYCLES", "?")
       logger.info(f"Running as part of campaign '{campaign_name}' (cycle {cycle}/{total})")
   ```

2. This provides traceability in experiment logs when reviewing results from campaign runs.

3. If launcher uses rich console, adapt to use console.print() with appropriate formatting.
  </action>
  <verify>
```bash
grep -n "LEM_CAMPAIGN_ID" src/llenergymeasure/orchestration/launcher.py
# Should show campaign context logging
```
  </verify>
  <done>Launcher displays campaign context (name, cycle, total) in log output when running as part of a campaign.</done>
</task>

</tasks>

<verification>
1. Run linting: `ruff check src/llenergymeasure/cli/campaign.py src/llenergymeasure/cli/experiment.py src/llenergymeasure/orchestration/launcher.py`
2. Run formatting: `ruff format src/llenergymeasure/cli/campaign.py src/llenergymeasure/cli/experiment.py src/llenergymeasure/orchestration/launcher.py`
3. Verify --cycles flag removed: `lem experiment --help | grep -i cycle` should not show --cycles option
4. Verify LEM_CAMPAIGN_* env vars in campaign.py: `grep LEM_CAMPAIGN src/llenergymeasure/cli/campaign.py`
</verification>

<success_criteria>
- LEM_CAMPAIGN_ID, LEM_CAMPAIGN_NAME, LEM_CYCLE, LEM_TOTAL_CYCLES environment variables passed from campaign to experiment
- Experiment CLI suppresses "single cycle" warning when LEM_CAMPAIGN_ID is set
- Experiment CLI displays "Part of campaign X (cycle Y/Z)" when running in campaign context
- --cycles flag removed from experiment CLI (experiments are atomic)
- Launcher logs campaign context when present
- All code passes ruff check and format
</success_criteria>

<output>
After completion, create `.planning/phases/02.2-campaign-execution-model/02.2-01-SUMMARY.md`
</output>
