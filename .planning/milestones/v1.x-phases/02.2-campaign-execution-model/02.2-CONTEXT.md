# Phase 2.2 Context: Campaign Execution Model

**Date:** 2026-02-03
**Status:** Discussion complete, ready for planning

---

## Key Design Decision

**Cycles belong to campaigns only.** Experiments are always single atomic units. This simplifies the execution model significantly.

---

## Area A: Container Strategy UX

| Decision | Choice |
|----------|--------|
| Default strategy | Ephemeral (`docker compose run --rm`) |
| Override method | Config file + CLI flag (CLI wins) |
| Validation | Fail fast before campaign starts — check images built |
| Persistent opt-in | Always confirm when persistent mode used |
| Container startup | Configurable (eager vs lazy) |
| Warmup delay | Configurable delay after container start |
| Single experiments | Respect config (can use containers if configured) |
| Teardown | Configurable `auto_teardown` setting |

**Note:** Image validation already implemented (`_check_docker_images()` in campaign.py).

---

## Area B: Campaign Context Display

| Decision | Choice |
|----------|--------|
| Detail level | Standard (progress, cycle, config name, ETA) |
| Cycle display | Header per cycle start (`=== Cycle 2 of 3 ===`) |
| Campaign context | Always show campaign ID/name in experiments |
| CI warning | Remove entirely from experiments (campaign-level only) |
| Quiet mode | `--quiet` flag logs to file only |
| Completion summary | Stats + failures list |
| Failed experiments | Inline red indicator, continue execution |
| Progress file | JSON file in `.lem-state/` updated per experiment |

---

## Area C: Local vs Docker Execution Model

| Decision | Choice |
|----------|--------|
| Execution support | Both local and Docker |
| Single-backend default | User preference in config (set during `lem init`) |
| Multi-backend campaigns | Always Docker |
| Orchestrator location | Always on host (industry standard confirmed) |

### Install Flow

| Decision | Choice |
|----------|--------|
| Install method | `pip install llenergymeasure` then `lem init` on first run |
| Config location | `.lem-config.yaml` in project root |
| Makefile | Yes (setup/dev/docker targets) |
| Docker images | Prompt during setup (which backends to build) |
| System detection | Show diagnostic summary during init |
| Reconfigure | `lem init --reconfigure` to update preferences |

### Setup Wizard Preferences

- Execution mode (local/Docker preference)
- Default backend
- Thermal gap settings (between experiments, between cycles)
- Results directory
- Notification webhooks (Slack/Discord)
- Default dataset (AI Energy Score)
- Logging verbosity

---

## Area D: Error Handling & Recovery

### Container Failures

| Decision | Choice |
|----------|--------|
| On container fail | Mark failed, continue campaign |
| Auto-retry | Yes, configurable `retry.max_attempts` (default 1) |
| OOM retry | Retry with same settings (transient often resolves) |
| Error classification | Categorised: config/runtime/resource |
| Error logs | Capture last 100 lines of container output |

### Interrupt Handling

| Decision | Choice |
|----------|--------|
| Ctrl+C behaviour | Save state, exit cleanly |
| Grace period | 5s grace, then force-kill on second Ctrl+C |

### Campaign-Level Safety

| Decision | Choice |
|----------|--------|
| Failure threshold | Configurable (default 50%), pause and prompt user |
| Threshold scope | Configurable: `campaign` (default) or `per_cycle` |

---

## Success Criteria (from ROADMAP.md)

1. TensorRT experiments route to correct container
2. Experiments display campaign context instead of "single cycle" warning
3. User can configure `docker.strategy: persistent`
4. CLI flag `--container-strategy` overrides config
5. CI warning suppressed for campaign experiments
6. Thermal gap defaults configurable

---

## Clarifications (Final)

| Question | Decision |
|----------|----------|
| Persistent mode scope | Full implementation (not deferred) |
| `--cycles` experiment flag | Remove entirely (experiments are atomic) |
| `lem init` wizard | Phase 2.3 scope (user preferences + state/resume) |

---

## Implementation Notes

- Cycles parameter moved from experiment config to campaign config only
- Campaign manifest already tracks per-experiment status
- `_check_docker_images()` already validates image availability
- Error classification may need new `ExperimentStatus` enum values
- Persistent mode requires re-implementing ContainerManager lifecycle
- Experiment CLI loses `--cycles` flag; campaigns own repetition

---

## Out of Scope (Phase 2.3)

- `lem init` setup wizard
- `.lem-config.yaml` creation/management
- `lem resume` command
- State directory structure (`.lem-state/`)
- Full user preferences system

---

## References

- `.planning/ARCHITECTURE-DISCUSSION.md` — High-level architecture decisions
- `.planning/debug/container-strategy-research.md` — `run --rm` vs `up + exec` analysis
- `src/llenergymeasure/cli/campaign.py` — Current campaign implementation
