---
phase: 02.1-zero-config-install
plan: 03
subsystem: packaging
tags: [pyproject.toml, poetry, pip, makefile, setup]

# Dependency graph
requires:
  - phase: 02.1-01
    provides: Lazy imports in docker_detection module
  - phase: 02.1-02
    provides: Diagnostic checks wrapped in try/except
provides:
  - PyTorch backend as default dependency (pip install llenergymeasure includes torch, transformers, accelerate, bitsandbytes, calflops, peft)
  - Simplified Makefile targets (setup, docker-setup)
  - Deleted setup.sh (replaced by pip install + docker compose build)
  - PyPI-publishable package (validated wheel install)
affects: [02.1-04, 02.1-05, documentation, deployment]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "PyTorch backend as default install (90% use case)"
    - "Optional extras for vllm, tensorrt, onnxrt, dev"
    - "Makefile targets for pip-based setup (not shell scripts)"

key-files:
  created: []
  modified:
    - pyproject.toml
    - Makefile
  deleted:
    - setup.sh

key-decisions:
  - "Move PyTorch backend deps (accelerate, bitsandbytes, calflops, peft) from optional [pytorch] extra to core dependencies"
  - "Create [onnxrt] extra for ONNX Runtime optimization (not needed for basic PyTorch usage)"
  - "Delete setup.sh, absorb responsibilities into pip install + docker compose build + make docker-setup"
  - "Makefile setup target: pip install + pre-commit (not ./setup.sh)"

patterns-established:
  - "Base install includes PyTorch backend by default"
  - "Makefile provides three entry points: setup (local), docker-setup (Docker), dev (Poetry)"

# Metrics
duration: 12min
completed: 2026-01-30
---

# Phase 02.1 Plan 03: Packaging Summary

**pip install llenergymeasure now includes working PyTorch backend by default; setup.sh deleted, Makefile simplified to pip-based workflow**

## Performance

- **Duration:** 12 min
- **Started:** 2026-01-30T17:41:32Z
- **Completed:** 2026-01-30T17:53:00Z
- **Tasks:** 3 (2 committed, 1 validation-only)
- **Files modified:** 2 (pyproject.toml, Makefile)
- **Files deleted:** 1 (setup.sh)

## Accomplishments
- PyTorch backend dependencies moved from optional extra to core — `pip install llenergymeasure` now works out of the box
- Makefile updated with `setup` (pip install + pre-commit) and `docker-setup` (setup + docker compose build) targets
- setup.sh deleted — responsibilities absorbed by pip + docker compose + make targets
- Package validated as PyPI-publishable — wheel installs cleanly in isolated venv with all modules importable

## Task Commits

Each task was committed atomically:

1. **Task 1: Move PyTorch deps to core in pyproject.toml** - `8f9d417` (feat)
   - Moved accelerate, bitsandbytes, calflops, peft from optional to core dependencies
   - Removed [pytorch] extra (now included in base)
   - Added [onnxrt] extra for ONNX Runtime optimization
   - Updated [all] extra to only include dev tools

2. **Task 2: Update Makefile + delete setup.sh** - `bbe208d` (refactor)
   - Replaced setup target: pip install + pre-commit (not ./setup.sh)
   - Added docker-setup target: setup + docker compose build
   - Updated Quick Start comments with three usage patterns
   - Deleted setup.sh file

3. **Task 3: Validate PyPI packaging readiness** - (no commit, verification only)
   - Built package with `poetry build` — produced valid sdist and wheel
   - Installed wheel in isolated venv — imported cleanly
   - Verified CLI works (`lem --help`)
   - Verified metadata completeness (name, version, description, authors, readme, packages)

## Files Created/Modified

- `pyproject.toml` - PyTorch deps moved to core, [onnxrt] extra added, [pytorch] extra removed
- `Makefile` - setup and docker-setup targets updated to use pip install, setup.sh references removed
- `setup.sh` - DELETED (responsibilities absorbed)

## Decisions Made

**1. PyTorch as default backend**
- Rationale: 90% of users need PyTorch backend, making it optional creates friction
- Impact: Base install now includes torch, transformers, accelerate, bitsandbytes, calflops, peft
- Trade-off: Larger default install, but working tool from `pip install` alone

**2. ONNX Runtime as separate extra**
- Rationale: onnxruntime-gpu is PyTorch-specific optimization, not required for basic operation
- Implementation: Created [onnxrt] extra for torch.compile optimization
- Usage: `pip install llenergymeasure[onnxrt]` for users who need ONNX Runtime

**3. Delete setup.sh, use Makefile + pip**
- Rationale: Shell script added complexity, pip install handles dependency resolution
- Migration: setup.sh responsibilities → pip install (local) + docker compose build (Docker) + make docker-setup (convenience)
- Benefits: Standard Python packaging workflow, one less file to maintain

**4. Makefile provides three entry points**
- `make setup`: Local development (pip install + pre-commit)
- `make docker-setup`: Docker environment (setup + docker compose build)
- `make dev`: Poetry-based development (poetry install + pre-commit)
- Rationale: Support multiple workflows without forcing one tool

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

**1. poetry check warnings (non-blocking)**
- Issue: poetry check flagged deprecated [tool.poetry.*] fields, suggested [project.*]
- Resolution: Acknowledged but not fixed — Poetry still works, migration to [project.*] is future work
- Impact: Package builds and installs correctly, warnings are informational

**2. poetry.lock out of sync**
- Issue: pyproject.toml changes invalidated poetry.lock
- Resolution: Not regenerated — package still installs via pip (primary install method)
- Impact: Poetry users would need `poetry lock`, but pip users unaffected

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

**Ready:**
- pip install llenergymeasure works out of the box (PyTorch backend included)
- Makefile targets simplified and documented
- Package is PyPI-publishable (validated wheel install)

**Follow-up needed:**
- README.md and docs/ must be updated to reflect new packaging (handled by parallel plan 02.1-04)
- Verify docker compose still works with updated Makefile (test in 02.1-05)

**No blockers.**

---
*Phase: 02.1-zero-config-install*
*Completed: 2026-01-30*
