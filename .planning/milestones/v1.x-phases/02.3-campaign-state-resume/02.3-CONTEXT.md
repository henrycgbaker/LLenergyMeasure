# Phase 2.3: Campaign State & Resume — Context

**Date:** 2026-02-03
**Depends on:** Phase 2.2 (Campaign Execution Model) ✅

## Phase Goal

Robust campaign state persistence with graceful interrupt handling, `lem resume` command, and user preferences configuration.

## What's Already Done (Phase 2.2)

| Capability | Status | Location |
|------------|--------|----------|
| Manifest tracking | ✅ Done | `orchestration/manifest.py` |
| Ctrl+C saves state cleanly | ✅ Done | `experiment.py:387-443`, `campaign.py:569,746` |
| Resume check before config | ✅ Done | `campaign.py:289-319` |
| Basic user config | ✅ Done | `config/user_config.py` (thermal_gaps, docker) |

## What Phase 2.3 Builds

1. **`lem resume` command** — Interactive discovery and resume of interrupted work
2. **`lem init` command** — Guided onboarding wizard for project setup
3. **Expanded UserConfig** — Webhook notifications with full implementation
4. **State gitignore** — Add `.state/` to `.gitignore`

---

## Decisions

### D1: `lem resume` UX Flow

**Presentation:** Interactive menu (arrow keys/numbers to select)

**Information shown for campaigns:** Summary table with:
- Completed/failed/pending counts
- Progress percentage
- Last activity timestamp

**Precedence:** Most recent first (sort by last activity, regardless of campaign vs experiment)

**Actions available:**
- Resume (execute immediately)
- Restart
- Wipe state (with y/n confirmation)

**Behaviour:**
- Single interrupted item: Auto-select, go straight to action choice
- Execute immediately when user selects "Resume" (no extra confirmation)
- Failed experiments: Ask user "Retry N failed experiments? [y/n]"
- Supports `--dry-run` flag to show what would be resumed
- Supports `--wipe` flag to clear all state (requires confirmation)

### D2: `lem init` Wizard Experience

**Purpose:** Guided onboarding — walk through setup, explain each option, show next steps

**Verbosity:** Balanced — brief explanation for each question, tips where helpful

**Flow:**
1. Detect and display environment info first (GPU, Docker, backends status)
2. Questions in logical order:
   - Environment (docker strategy)
   - Outputs (results directory)
   - Behaviour (thermal gaps, webhooks)
3. If config exists: Offer to update (load existing, ask which fields to change)
4. After creation: Run `lem doctor` automatically to verify setup
5. Show minimal next steps: "Config created. Run lem --help to get started."

**Non-interactive mode:** Yes, with value flags
- `lem init --non-interactive` uses defaults
- `lem init --non-interactive --results-dir /data --webhook-url https://...`

### D3: User Preferences Scope

**File:** `.lem-config.yaml` (project-local only, no global fallback)

**Fields included:**
- ~~`default_backend`~~ — REMOVED (backend should always be explicit in experiment/campaign config)
- `results_dir` — Default results directory
- `thermal_gaps.between_experiments` — Seconds between experiments
- `thermal_gaps.between_cycles` — Seconds between cycles
- `docker.strategy` — ephemeral or persistent
- `docker.warmup_delay` — Seconds after container start
- `docker.auto_teardown` — Auto-cleanup containers
- `notifications.webhook_url` — URL for POST notifications
- `notifications.on_complete` — Send on success
- `notifications.on_failure` — Send on failure

**Webhooks:** Full implementation in Phase 2.3 — actually POST to webhook URL when experiments complete/fail

**Validation:** Fail fast — error message and refuse to run if config has invalid values

### D4: State Directory & Naming

**Directory name:** Keep `.state/` for Phase 2.3 (no rename)
- Full rename (`lem` → `llem`, `.state/` → `.llem-state/`) deferred to Phase 4

**Git tracking:** Add `.state/` to `.gitignore` (state is ephemeral, shouldn't be committed)

**Cleanup policy:** No auto-cleanup — user manually deletes via `lem resume --wipe`

**Manifest retention:** Delete on completion — manifest is only for resume, not history

---

## Deferred Ideas (Phase 4)

- Full rename: `lem` → `llem`, `.lem-config.yaml` → `.llem-config.yaml`, `.state/` → `.llem-state/`
- Global user config in `~/.config/llenergymeasure/`
- Age-based state cleanup

---

## Success Criteria Mapping

| Roadmap Criterion | Implementation |
|-------------------|----------------|
| State persists to `.lem-state/` | Keep `.state/` for now, rename deferred to Phase 4 |
| `lem resume` command | New CLI command with interactive menu, dry-run, wipe |
| Ctrl+C saves state cleanly | ✅ Already done |
| Resume check before config | ✅ Already done |
| User prefs support webhooks | Extend `UserConfig`, implement actual webhook POST |
| Campaign precedence | Sort by most recent activity |

---

## Key Files to Create/Modify

| File | Change |
|------|--------|
| `src/llenergymeasure/cli/resume.py` | NEW — `lem resume` command |
| `src/llenergymeasure/cli/init.py` | NEW — `lem init` command |
| `src/llenergymeasure/config/user_config.py` | MODIFY — Remove default_backend, add notifications, add validation |
| `src/llenergymeasure/notifications/webhook.py` | NEW — Webhook sender implementation |
| `.gitignore` | MODIFY — Add `.state/` |

---

## References

- `.planning/ARCHITECTURE-DISCUSSION.md` — Original design decisions
- `src/llenergymeasure/orchestration/manifest.py` — Existing manifest infrastructure
- `src/llenergymeasure/state/experiment_state.py` — Existing state management
