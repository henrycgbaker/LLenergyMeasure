---
phase: 02.3-campaign-state-resume
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/llenergymeasure/cli/init_cmd.py
  - src/llenergymeasure/cli/__init__.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User runs `lem init` and walks through guided setup wizard"
    - "User sees environment detection (GPU, Docker, backends) before questions"
    - "User can update existing config by running `lem init` again"
    - "User runs `lem init --non-interactive` and config is created with defaults"
    - "`lem doctor` runs automatically after config creation"
  artifacts:
    - path: "src/llenergymeasure/cli/init_cmd.py"
      provides: "`lem init` wizard command"
      min_lines: 100
  key_links:
    - from: "src/llenergymeasure/cli/init_cmd.py"
      to: "cli/doctor.py"
      via: "doctor_cmd() call"
      pattern: "doctor_cmd"
    - from: "src/llenergymeasure/cli/init_cmd.py"
      to: "config/user_config.py"
      via: "UserConfig model"
      pattern: "UserConfig"
---

<objective>
Implement `lem init` wizard for guided project setup.

Purpose: Provide a friendly onboarding experience that detects the environment, guides users through configuration options, and validates setup with `lem doctor`.

Output: Working `lem init` command with interactive wizard and non-interactive mode.
</objective>

<execution_context>
@/Users/henrybaker/.claude/get-shit-done/workflows/execute-plan.md
@/Users/henrybaker/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02.3-CONTEXT.md
@.planning/phases/02.3-campaign-state-resume/02.3-RESEARCH.md

# Existing patterns to follow
@src/llenergymeasure/cli/doctor.py
@src/llenergymeasure/config/user_config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create environment detection helper</name>
  <files>
    src/llenergymeasure/cli/init_cmd.py
  </files>
  <action>
Create `init_cmd.py` with environment detection helper function (reuse patterns from doctor.py):

```python
def _detect_environment() -> dict[str, Any]:
    """Detect environment info for init wizard display.

    Returns dict with:
    - python_version: str
    - in_venv: bool
    - venv_name: str | None
    - cuda_available: bool
    - gpu_count: int
    - docker_available: bool
    - docker_running: bool
    - backends: dict[str, bool]  # backend_name -> is_available
    """
```

Implementation:
- Python: `sys.version.split()[0]`, check `sys.prefix != sys.base_prefix`
- CUDA: Try import torch, check `torch.cuda.is_available()`, get device count
- Docker: `shutil.which("docker")`, run `docker info` with timeout
- Backends: Lazy import `backend_detection.is_backend_available()` for each known backend

Wrap all detection in try/except to ensure it never crashes (same pattern as doctor.py).
  </action>
  <verify>
    Code compiles: `python -c "from llenergymeasure.cli.init_cmd import _detect_environment"`
  </verify>
  <done>
    Environment detection helper exists and handles all errors gracefully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement `lem init` wizard command</name>
  <files>
    src/llenergymeasure/cli/init_cmd.py
    src/llenergymeasure/cli/__init__.py
  </files>
  <action>
1. Add the `init_cmd` command to `init_cmd.py`:

   Add imports at top of file:
   ```python
   import shutil
   import subprocess
   import sys
   from pathlib import Path
   from typing import Annotated, Any

   import questionary
   import typer
   import yaml

   from llenergymeasure.cli.display import console
   from llenergymeasure.config.user_config import UserConfig, NotificationsConfig
   ```

   Command signature:
   ```python
   def init_cmd(
       non_interactive: Annotated[bool, typer.Option("--non-interactive", help="Use defaults without prompts")] = False,
       results_dir: Annotated[str | None, typer.Option("--results-dir", help="Results directory")] = None,
       webhook_url: Annotated[str | None, typer.Option("--webhook-url", help="Webhook URL for notifications")] = None,
   ) -> None:
       """Initialize project with guided configuration wizard."""
   ```

2. Wizard flow (per CONTEXT.md decision D2):

   a. Check for existing config:
      - If `.lem-config.yaml` exists:
        - `update = typer.confirm("Config already exists. Update it?", default=False)`
        - If no, print "Cancelled" and return
        - If yes, load existing config as defaults

   b. Non-interactive mode:
      - If `--non-interactive`:
        - Create UserConfig with CLI args or defaults
        - Skip to write step

   c. Interactive wizard:
      - Print header: "[bold]LLenergyMeasure Configuration Wizard[/bold]"

      - Detect and display environment:
        ```
        [dim]Environment detected:[/dim]
          Python: 3.11.0
          GPU:    [green]✓[/green] 1 x NVIDIA A100
          Docker: [green]✓[/green] running
        ```

      - Questions in order (per decision D2):
        1. Results directory: `questionary.text("Results directory:", default=existing.results_dir).ask()`
        2. Thermal gap between experiments: `questionary.text("Thermal gap between experiments (seconds):", default=str(...)).ask()`
        3. Docker strategy (only if Docker available): `questionary.select("Docker strategy:", choices=["ephemeral", "persistent"]).ask()`
        4. Webhook URL: `questionary.text("Webhook URL (optional):", default="").ask()` with validation lambda: `lambda url: True if not url or url.startswith(("http://", "https://")) else "Must start with http:// or https://"`

      - Handle Ctrl+C on any questionary.ask() returning None: `raise typer.Abort()`

   d. Build and write config:
      - Create UserConfig from collected values
      - Use `yaml.safe_dump(config.model_dump(exclude_none=True), ...)`
      - Write to `.lem-config.yaml`
      - Print success: "[green]✓[/green] Config written to .lem-config.yaml"

   e. Run doctor:
      - Print "[dim]Running diagnostics...[/dim]"
      - Call `doctor_cmd()` (import lazily from cli.doctor)

   f. Show next steps:
      - Print "Run `lem --help` to get started."

3. Register in `cli/__init__.py`:
   - Add `init_cmd` to imports in `_register_commands()`
   - Add `app.command("init")(init_cmd.init_cmd)`

Note: Name file `init_cmd.py` not `init.py` to avoid shadowing Python's built-in `init` module patterns.
  </action>
  <verify>
    `lem init --help` shows command with --non-interactive, --results-dir, --webhook-url options.
    `lem init --non-interactive` creates `.lem-config.yaml` file.
  </verify>
  <done>
    `lem init` wizard works interactively and non-interactively, runs doctor after completion.
  </done>
</task>

</tasks>

<verification>
1. `lem init --help` shows all options
2. `lem init --non-interactive` creates config file with defaults
3. `lem init --non-interactive --results-dir /tmp/results` creates config with custom results_dir
4. Running `lem init` interactively shows environment detection, prompts for each field, runs doctor
5. Running `lem init` with existing config asks about updating
</verification>

<success_criteria>
- `lem init` command registered and functional
- Interactive mode shows environment detection before questions
- Non-interactive mode accepts CLI flags for values
- Existing config prompts for update confirmation
- Doctor runs automatically after config creation
- All questionary prompts handle Ctrl+C gracefully
</success_criteria>

<output>
After completion, create `.planning/phases/02.3-campaign-state-resume/02.3-02-SUMMARY.md`
</output>
